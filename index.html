<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trading Profit Challenge</title>
    <style>
        :root {
            --background-color: #f0f2f5;
            --chart-background: #ffffff;
            --text-color: #1c1e21;
            --border-color: #dce1e6;
            --primary-button-bg: #1877f2;
            --primary-button-text: #ffffff;
            --primary-button-hover: #166fe5;
            --secondary-button-bg: #e4e6eb;
            --secondary-button-text: #050505;
            --secondary-button-hover: #d8dadf;
            --buy-color: #42b72a;
            --sell-color: #f02849;
            --buy-color-light: rgba(66, 183, 42, 0.1);
            --sell-color-light: rgba(240, 40, 73, 0.1);
            --sl-color: #fa3838;
            --tp-color: #26a69a;
            --inactive-tab-bg: #e9eaec;
            --active-tab-bg: #ffffff;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        #header {
            padding: 8px 12px;
            background-color: var(--chart-background);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }

        #header .info {
            font-size: 14px;
        }

        #header .info span {
            margin-right: 16px;
        }

        #chart-container {
            flex-grow: 1;
            position: relative;
        }

        #chart-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #bottom-panel {
            flex-shrink: 0;
            background-color: var(--background-color);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
        }

        #tab-buttons {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-button {
            flex: 1;
            padding: 12px;
            text-align: center;
            background-color: var(--inactive-tab-bg);
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            border-right: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }
        .tab-button:active {
            filter: brightness(0.95);
        }

        .tab-button:last-child {
            border-right: none;
        }

        .tab-button.active {
            background-color: var(--active-tab-bg);
            border-bottom: 2px solid var(--primary-button-bg);
            margin-bottom: -1px;
        }

        .tab-content {
            display: none;
            padding: 12px;
        }

        .tab-content.active {
            display: block;
        }

        #trade-panel .trade-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        
        .input-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .input-row label {
            width: 80px;
            font-size: 14px;
        }
        
        .input-wrapper {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }

        .input-wrapper input {
            flex-grow: 1;
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
            background-color: var(--chart-background);
            color: var(--text-color);
            -moz-appearance: textfield;
        }
        
        .input-wrapper input::-webkit-outer-spin-button,
        .input-wrapper input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .step-button {
            width: 30px;
            height: 30px;
            border: 1px solid var(--border-color);
            background-color: var(--secondary-button-bg);
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            color: var(--secondary-button-text);
            transition: background-color 0.1s;
        }
        .step-button:active {
             background-color: var(--secondary-button-hover);
        }

        #positions-panel table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        #positions-panel th,
        #positions-panel td {
            border: 1px solid var(--border-color);
            padding: 6px;
            text-align: center;
        }

        #positions-panel th {
            background-color: var(--secondary-button-bg);
        }
        
        .close-pos-btn {
            background: none;
            border: none;
            color: var(--sell-color);
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        .close-pos-btn:active {
            opacity: 0.7;
        }

        .buy-button, .sell-button {
            flex-grow: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            color: var(--primary-button-text);
            cursor: pointer;
            transition: transform 0.1s ease, background-color 0.2s;
        }
        .buy-button:active, .sell-button:active {
             transform: scale(0.98);
        }

        .buy-button { background-color: var(--buy-color); }
        .buy-button:hover { background-color: #3aa122; }
        .sell-button { background-color: var(--sell-color); }
        .sell-button:hover { background-color: #d82341; }
        
        #playback-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #playback-controls button {
            background-color: var(--secondary-button-bg);
            border: 1px solid var(--border-color);
            color: var(--secondary-button-text);
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.1s;
        }
        #playback-controls button:hover { background-color: var(--secondary-button-hover); }
        #playback-controls button:active { filter: brightness(0.9); }

        #playback-controls select {
            padding: 6px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        #tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 999;
            display: none;
        }
        #tutorial-highlight {
            position: absolute;
            border: 3px solid #1877f2;
            border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6);
            transition: all 0.4s ease-in-out;
            pointer-events: none;
        }
        #tutorial-box {
            position: absolute;
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 8px;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        #tutorial-box p { margin: 0 0 15px 0; font-size: 16px; line-height: 1.5; }
        #tutorial-box button {
            background-color: #1877f2; color: white; border: none; padding: 10px 20px;
            font-size: 16px; border-radius: 6px; cursor: pointer; float: right;
        }

        #end-card {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); z-index: 1000; display: none;
            justify-content: center; align-items: center;
        }
        #end-card-content {
            background: var(--chart-background); padding: 30px; border-radius: 12px;
            text-align: center; width: 80%; max-width: 400px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        #end-card-content h2 { margin-top: 0; font-size: 24px; }
        #end-card-content p { font-size: 18px; margin: 15px 0; }
        .final-profit { font-weight: bold; font-size: 28px; }
        .profit-positive { color: var(--buy-color); }
        .profit-negative { color: var(--sell-color); }
        #cta-button {
            display: inline-block; background-color: var(--buy-color); color: white;
            padding: 15px 30px; border: none; border-radius: 8px; font-size: 18px;
            font-weight: bold; text-decoration: none; margin-top: 20px; cursor: pointer;
            transition: background-color 0.2s;
        }
        #cta-button:hover { background-color: #3aa122; }
    </style>
</head>

<body>
    <div id="app-container">
        <div id="header">
            <div id="challenge-info" class="info">
                <span>日期: <span id="current-date">--</span></span>
                <span>淨值: <span id="equity-value">10000.00</span></span>
                <span>總損益: <span id="total-pnl">0.00</span></span>
            </div>
            <div id="playback-controls">
                 <button id="play-pause-btn">▶</button>
                 <button id="next-candle-btn">→</button>
                 <select id="speed-selector">
                    <option value="1000">x1</option>
                    <option value="500">x2</option>
                    <option value="250">x4</option>
                    <option value="100">x8</option>
                </select>
            </div>
        </div>
        <div id="chart-container">
            <canvas id="chart-canvas"></canvas>
        </div>
        <div id="bottom-panel">
            <div id="tab-buttons">
                <button class="tab-button active" data-tab="trade-panel">交易</button>
                <button class="tab-button" data-tab="positions-panel">持倉 (<span id="position-count">0</span>)</button>
            </div>
            <div id="trade-panel" class="tab-content active">
                 <div class="input-row">
                    <label for="sl-input">停損價</label>
                    <div class="input-wrapper">
                        <button class="step-button" data-input="sl-input" data-step="-1">-</button>
                        <input type="number" id="sl-input" step="0.1">
                        <button class="step-button" data-input="sl-input" data-step="1">+</button>
                    </div>
                </div>
                <div class="input-row">
                    <label for="tp-input">停利價</label>
                    <div class="input-wrapper">
                         <button class="step-button" data-input="tp-input" data-step="-1">-</button>
                        <input type="number" id="tp-input" step="0.1">
                        <button class="step-button" data-input="tp-input" data-step="1">+</button>
                    </div>
                </div>
                 <div class="trade-actions">
                    <button id="sell-btn" class="sell-button">賣出</button>
                    <button id="buy-btn" class="buy-button">買入</button>
                </div>
            </div>
            <div id="positions-panel" class="tab-content">
                <table id="positions-table">
                    <thead>
                        <tr>
                            <th>類型</th>
                            <th>價格</th>
                            <th>SL</th>
                            <th>TP</th>
                            <th>損益</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="tutorial-overlay">
        <div id="tutorial-highlight"></div>
        <div id="tutorial-box">
            <p id="tutorial-text"></p>
            <button id="tutorial-next-btn">下一步</button>
        </div>
    </div>

    <div id="end-card">
        <div id="end-card-content">
            <h2>挑戰結束！</h2>
            <p>您的最終淨值為：</p>
            <p id="final-equity" class="final-profit profit-positive">$10,523.45</p>
            <a id="cta-button" href="https://www.google.com" target="_blank">了解更多</a>
        </div>
    </div>

    <script>
    // =================================================================================
    // MAIN APPLICATION LOGIC
    // =================================================================================
    
    class TradingChart {
        constructor(canvasId) {
            this.canvas = document.getElementById(canvasId);
            this.ctx = this.canvas.getContext('2d');
            this.ohlcData = [];
            this.visibleCandles = [];
            this.animations = [];
            this.candleWidth = 8;
            this.candleSpacing = 4;
            this.zoom = 1.0;
            this.panX = 0;
            this.minPrice = Infinity;
            this.maxPrice = -Infinity;
            this.isDragging = false;
            this.lastMouseX = 0;

            this.resizeCanvas();
            window.addEventListener('resize', () => this.resizeCanvas());
            this.canvas.addEventListener('mousedown', (e) => this.onMouseDown(e));
            this.canvas.addEventListener('mousemove', (e) => this.onMouseMove(e));
            this.canvas.addEventListener('mouseup', () => this.onMouseUp());
            this.canvas.addEventListener('mouseleave', () => this.onMouseUp());
            this.canvas.addEventListener('wheel', (e) => this.onWheel(e));
            this.startAnimationLoop();
        }

        resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const rect = this.canvas.getBoundingClientRect();
            this.canvas.width = rect.width * dpr;
            this.canvas.height = rect.height * dpr;
            this.ctx.scale(dpr, dpr);
        }

        setData(data, visibleCandles) {
            this.ohlcData = data;
            this.visibleCandles = visibleCandles.map(c => ({...c, animProgress: 1}));
            this.calculatePriceRange();
        }
         
        updateData(newData) {
            this.visibleCandles = newData.map(c => {
                const existing = this.visibleCandles.find(vc => vc.time === c.time);
                return existing ? existing : {...c, animProgress: 0};
            });
            this.calculatePriceRange();
        }

        calculatePriceRange() {
            if (this.visibleCandles.length === 0) return;
            let min = Infinity, max = -Infinity;
            this.visibleCandles.forEach(candle => {
                min = Math.min(min, candle.low);
                max = Math.max(max, candle.high);
            });
            const padding = (max - min) * 0.1;
            this.minPrice = min - padding;
            this.maxPrice = max + padding;
        }

        startAnimationLoop() {
            const loop = () => {
                this.draw();
                requestAnimationFrame(loop);
            };
            requestAnimationFrame(loop);
        }

        draw() {
            if (!this.ctx) return;
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.drawDateSeparators();
            this.drawCandles();
            this.drawPriceAxis();
            this.drawPositions();
            this.drawAnimations();
        }
        
        drawPositions() {
            if (!window.positions) return;
            positions.forEach(pos => {
                const y = this.priceToY(pos.entryPrice);
                this.drawPositionLine(pos.entryPrice, 'blue', pos.pnl);
                if (pos.sl) this.drawPositionLine(pos.sl, 'var(--sl-color)');
                if (pos.tp) this.drawPositionLine(pos.tp, 'var(--tp-color)');
            });
        }

        drawPositionLine(price, color, pnl = null) {
            const y = this.priceToY(price);
            this.ctx.beginPath();
            this.ctx.setLineDash([5, 5]);
            this.ctx.strokeStyle = color;
            this.ctx.moveTo(0, y);
            this.ctx.lineTo(this.canvas.clientWidth - 50, y);
            this.ctx.stroke();
            this.ctx.setLineDash([]);
            
            this.ctx.fillStyle = 'white';
            this.ctx.font = '12px Arial';
            this.ctx.textAlign = 'right';
            const priceText = price.toFixed(2);
            const textWidth = this.ctx.measureText(priceText).width;
            this.ctx.fillRect(this.canvas.clientWidth - 50 - textWidth - 10, y - 8, textWidth + 10, 16);
            this.ctx.fillStyle = color;
            this.ctx.fillText(priceText, this.canvas.clientWidth - 55, y + 4);

            if (pnl !== null) {
                const pnlText = (pnl >= 0 ? '+' : '') + pnl.toFixed(2);
                const pnlColor = pnl >= 0 ? 'var(--buy-color)' : 'var(--sell-color)';
                this.ctx.fillStyle = pnlColor;
                this.ctx.textAlign = 'left';
                this.ctx.fillText(pnlText, 10, y - 5);
            }
        }

        drawDateSeparators() {
            if (this.visibleCandles.length === 0) return;

            this.ctx.strokeStyle = '#e0e0e0';
            this.ctx.lineWidth = 1;
            this.ctx.font = '12px Arial';
            this.ctx.fillStyle = '#888';
            let lastDate = null;

            for (let i = 0; i < this.visibleCandles.length; i++) {
                const candle = this.visibleCandles[i];
                const date = new Date(candle.time * 1000);
                const candleDateStr = date.toDateString();
                if (lastDate && candleDateStr !== lastDate) {
                    const x = this.getXPosition(i);
                    this.ctx.beginPath();
                    this.ctx.setLineDash([4, 4]);
                    this.ctx.moveTo(x, 0);
                    this.ctx.lineTo(x, this.canvas.clientHeight);
                    this.ctx.stroke();
                    this.ctx.setLineDash([]);
                    this.ctx.textAlign = 'left';
                    this.ctx.fillText(date.toLocaleDateString(), x + 5, this.canvas.clientHeight - 10);
                }
                lastDate = candleDateStr;
            }
        }

        getXPosition(index) {
            const totalCandleWidth = (this.candleWidth + this.candleSpacing) * this.zoom;
            return this.canvas.clientWidth - (this.visibleCandles.length - index) * totalCandleWidth - this.panX;
        }

        drawCandles() {
            if (this.visibleCandles.length === 0) return;
            const totalCandleWidth = (this.candleWidth + this.candleSpacing) * this.zoom;
            
            this.visibleCandles.forEach((candle, i) => {
                if (candle.animProgress < 1) {
                    candle.animProgress += 0.05; // Animation speed
                    if (candle.animProgress > 1) candle.animProgress = 1;
                }

                const x = this.getXPosition(i);
                if (x < -totalCandleWidth || x > this.canvas.clientWidth + totalCandleWidth) return;

                const openY = this.priceToY(candle.open);
                const closeY = this.priceToY(candle.close);
                const highY = this.priceToY(candle.high);
                const lowY = this.priceToY(candle.low);
                
                const isBullish = candle.close >= candle.open;
                this.ctx.strokeStyle = isBullish ? 'var(--buy-color)' : 'var(--sell-color)';
                this.ctx.fillStyle = isBullish ? 'var(--buy-color)' : 'var(--sell-color)';
                
                // Animated Drawing Logic
                const p = candle.animProgress;
                let currentHigh = highY, currentLow = lowY, currentClose = closeY;

                if (p < 0.25) { // Open
                    currentHigh = openY; currentLow = openY; currentClose = openY;
                } else if (p < 0.75) { // High/Low
                    const highLowProgress = (p - 0.25) / 0.5;
                    currentHigh = openY + (highY - openY) * highLowProgress;
                    currentLow = openY + (lowY - openY) * highLowProgress;
                    currentClose = openY;
                } else { // Close
                    const closeProgress = (p - 0.75) / 0.25;
                    currentClose = openY + (closeY - openY) * closeProgress;
                }
                
                this.ctx.beginPath();
                this.ctx.moveTo(x + (this.candleWidth * this.zoom) / 2, highY);
                this.ctx.lineTo(x + (this.candleWidth * this.zoom) / 2, lowY);
                this.ctx.stroke();

                const bodyHeight = Math.max(1, Math.abs(openY - currentClose));
                const bodyY = Math.min(openY, currentClose);
                this.ctx.fillRect(x, bodyY, this.candleWidth * this.zoom, bodyHeight);
            });
        }

        drawPriceAxis() {
            const axisWidth = 50;
            const clientWidth = this.canvas.clientWidth;
            const clientHeight = this.canvas.clientHeight;
            
            this.ctx.fillStyle = 'var(--background-color)';
            this.ctx.fillRect(clientWidth - axisWidth, 0, axisWidth, clientHeight);
            this.ctx.strokeStyle = 'var(--border-color)';
            this.ctx.beginPath();
            this.ctx.moveTo(clientWidth - axisWidth, 0);
            this.ctx.lineTo(clientWidth - axisWidth, clientHeight);
            this.ctx.stroke();

            this.ctx.fillStyle = 'var(--text-color)';
            this.ctx.font = '12px Arial';
            this.ctx.textAlign = 'left';

            if (this.maxPrice === -Infinity) return;
            const priceRange = this.maxPrice - this.minPrice;
            if (priceRange <= 0) return;
            
            const numTicks = Math.floor(clientHeight / 50);
            for (let i = 0; i <= numTicks; i++) {
                const price = this.minPrice + (i / numTicks) * priceRange;
                const y = this.priceToY(price);
                this.ctx.fillText(price.toFixed(2), clientWidth - axisWidth + 5, y + 4);
                this.ctx.beginPath();
                this.ctx.moveTo(clientWidth - axisWidth, y);
                this.ctx.lineTo(clientWidth - axisWidth - 5, y);
                this.ctx.stroke();
            }
        }
         
        addOpenPositionAnimation(price, type) {
            const y = this.priceToY(price);
            const x = this.getXPosition(this.visibleCandles.length - 1);
            this.animations.push({ type: 'arrow', x, y, dir: type === 'buy' ? 1 : -1, life: 60 });
        }

        addClosePositionAnimation(price, pnl) {
            const y = this.priceToY(price);
            const x = this.getXPosition(this.visibleCandles.length - 1);
            this.animations.push({ type: 'pnl', x, y, pnl, life: 90, startY: y });
        }
        
        drawAnimations() {
            this.ctx.save();
            for (let i = this.animations.length - 1; i >= 0; i--) {
                const anim = this.animations[i];
                anim.life--;
                this.ctx.globalAlpha = Math.max(0, anim.life / 60);

                if (anim.type === 'arrow') {
                    this.ctx.fillStyle = anim.dir === 1 ? 'var(--buy-color)' : 'var(--sell-color)';
                    this.ctx.beginPath();
                    if (anim.dir === 1) {
                        this.ctx.moveTo(anim.x, anim.y); this.ctx.lineTo(anim.x - 5, anim.y + 10); this.ctx.lineTo(anim.x + 5, anim.y + 10);
                    } else {
                        this.ctx.moveTo(anim.x, anim.y); this.ctx.lineTo(anim.x - 5, anim.y - 10); this.ctx.lineTo(anim.x + 5, anim.y - 10);
                    }
                    this.ctx.fill();
                } else if (anim.type === 'pnl') {
                    const pnlText = (anim.pnl > 0 ? '+' : '') + anim.pnl.toFixed(2);
                    this.ctx.fillStyle = anim.pnl > 0 ? 'var(--buy-color)' : 'var(--sell-color)';
                    this.ctx.font = 'bold 14px Arial';
                    anim.y -= 0.5;
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(pnlText, anim.x, anim.y);
                }

                if (anim.life <= 0) this.animations.splice(i, 1);
            }
             this.ctx.restore();
        }

        priceToY(price) {
            const priceRange = this.maxPrice - this.minPrice;
            if (priceRange <= 0) return this.canvas.clientHeight / 2;
            return (1 - (price - this.minPrice) / priceRange) * this.canvas.clientHeight;
        }

        onMouseDown(e) { this.isDragging = true; this.lastMouseX = e.clientX; }
        onMouseMove(e) { if (this.isDragging) { const dx = e.clientX - this.lastMouseX; this.panX -= dx; this.lastMouseX = e.clientX; } }
        onMouseUp() { this.isDragging = false; }
        onWheel(e) { e.preventDefault(); const zoomFactor = e.deltaY < 0 ? 1.1 : 0.9; this.zoom = Math.max(0.1, Math.min(10, this.zoom * zoomFactor)); }
    }

    let ohlcData = [], currentIndex = 0, visibleCandles = [], isPlaying = false,
        gameInterval, candleSpeed = 500, chart, positions = [], nextPositionId = 1,
        account = { balance: 10000, equity: 10000 },
        VISIBLE_CANDLE_COUNT = 100, tutorialStep = 0;

    async function loadDataAndStart() {
        try {
            const response = await fetch('XAUUSD_M15.csv');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const text = await response.text();
            const parsedData = parseData(text);
            ohlcData = selectRandomMonth(parsedData);
            resetChallenge();
        } catch (error) {
            console.error("Fatal Error: Failed to load or process data.", error);
            alert("錯誤：無法載入或處理市場數據。");
        }
    }
    
    function parseData(text) {
        const lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim().split('\n');
        const header = lines.shift() || '';
        const isTimestampFormat = header.startsWith('time,') || /^\d{10,}/.test(lines[0]);
        const parser = isTimestampFormat ? parseTimestampCSV : parseDateTimeSpaceSeparated;
        return parser(lines);
    }

    function parseTimestampCSV(lines) {
        return lines.map(line => {
            const parts = line.split(',');
            if (parts.length < 5) return null;
            const p = { time: parseInt(parts[0], 10), open: parseFloat(parts[1]), high: parseFloat(parts[2]), low: parseFloat(parts[3]), close: parseFloat(parts[4]) };
            return Object.values(p).some(isNaN) ? null : p;
        }).filter(Boolean);
    }

    function parseDateTimeSpaceSeparated(lines) {
        return lines.map(line => {
            const parts = line.trim().split(/\s+/);
            if (parts.length < 6) return null;
            const dateString = parts[0].replace(/\./g, '-') + ' ' + parts[1];
            const time = new Date(dateString).getTime() / 1000;
            const p = { time, open: parseFloat(parts[2]), high: parseFloat(parts[3]), low: parseFloat(parts[4]), close: parseFloat(parts[5]) };
            return Object.values(p).some(isNaN) ? null : p;
        }).filter(Boolean);
    }

    function selectRandomMonth(data) {
        if (!data || data.length === 0) return [];
        const months = {};
        data.forEach(d => {
            const date = new Date(d.time * 1000);
            if (isNaN(date.getTime())) return;
            const key = `${date.getFullYear()}-${date.getMonth()}`;
            if (!months[key]) months[key] = [];
            months[key].push(d);
        });
        const keys = Object.keys(months);
        if (keys.length === 0) return [];
        const randomKey = keys[Math.floor(Math.random() * keys.length)];
        return months[randomKey] || [];
    }

    function resetChallenge() {
        if (!ohlcData || ohlcData.length === 0) {
            alert("錯誤：沒有有效的市場數據可以開始挑戰。"); return;
        }
        currentIndex = VISIBLE_CANDLE_COUNT;
        visibleCandles = ohlcData.slice(0, VISIBLE_CANDLE_COUNT);
        chart.setData(ohlcData, visibleCandles);
        updateUI();
        showTutorialStep(0);
    }

    function nextCandle() {
        if (currentIndex >= ohlcData.length - 1) {
            pauseGame(); showEndCard(); return;
        }
        currentIndex++;
        const newCandle = ohlcData[currentIndex];
        updatePositions(newCandle.close);
        chart.updateData(ohlcData.slice(Math.max(0, currentIndex - VISIBLE_CANDLE_COUNT), currentIndex + 1));
        updateUI();
    }

    function playPause() {
        isPlaying = !isPlaying;
        document.getElementById('play-pause-btn').textContent = isPlaying ? '❚❚' : '▶';
        if (isPlaying) gameInterval = setInterval(nextCandle, candleSpeed);
        else clearInterval(gameInterval);
    }
    
    function pauseGame() {
        if (isPlaying) { isPlaying = false; document.getElementById('play-pause-btn').textContent = '▶'; clearInterval(gameInterval); }
    }

    function setSpeed(speed) {
        candleSpeed = parseInt(speed);
        if (isPlaying) { clearInterval(gameInterval); gameInterval = setInterval(nextCandle, candleSpeed); }
    }

    function updateUI() {
        const candle = ohlcData[currentIndex];
        if (!candle) return;
        document.getElementById('current-date').textContent = new Date(candle.time * 1000).toLocaleString();
        const totalPnl = positions.reduce((sum, pos) => sum + pos.pnl, 0);
        account.equity = account.balance + totalPnl;
        document.getElementById('equity-value').textContent = account.equity.toFixed(2);
        document.getElementById('total-pnl').textContent = totalPnl.toFixed(2);
        updatePositionsTable();
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    }

    function openPosition(type) {
        const price = ohlcData[currentIndex].close;
        const sl = parseFloat(document.getElementById('sl-input').value) || null;
        const tp = parseFloat(document.getElementById('tp-input').value) || null;
        if (type === 'buy' && ((sl && sl >= price) || (tp && tp <= price))) { alert('買入訂單的停損/停利設定無效。'); return; }
        if (type === 'sell' && ((sl && sl <= price) || (tp && tp >= price))) { alert('賣出訂單的停損/停利設定無效。'); return; }
        positions.push({ id: nextPositionId++, type, entryPrice: price, sl, tp, pnl: 0 });
        chart.addOpenPositionAnimation(price, type);
        updateUI();
    }

    function closePosition(id) {
        const index = positions.findIndex(p => p.id === id);
        if (index > -1) {
            const pos = positions[index];
            account.balance += pos.pnl;
            chart.addClosePositionAnimation(ohlcData[currentIndex].close, pos.pnl);
            positions.splice(index, 1);
            updateUI();
        }
    }

    function updatePositions(price) {
        let closed = false;
        for (let i = positions.length - 1; i >= 0; i--) {
            const pos = positions[i];
            pos.pnl = (price - pos.entryPrice) * (pos.type === 'buy' ? 1 : -1) * 100;
            if ((pos.sl && (pos.type === 'buy' ? price <= pos.sl : price >= pos.sl)) ||
                (pos.tp && (pos.type === 'buy' ? price >= pos.tp : price <= pos.tp))) {
                closePosition(pos.id);
                closed = true;
            }
        }
        if (!closed) updateUI();
    }
    
    function updatePositionsTable() {
        const body = document.getElementById('positions-table').querySelector('tbody');
        body.innerHTML = '';
        document.getElementById('position-count').textContent = positions.length;
        positions.forEach(pos => {
            const row = body.insertRow();
            row.innerHTML = `
                <td style="color: ${pos.type === 'buy' ? 'var(--buy-color)' : 'var(--sell-color)'}">${pos.type.toUpperCase()}</td>
                <td>${pos.entryPrice.toFixed(2)}</td>
                <td>${pos.sl ? pos.sl.toFixed(2) : '--'}</td>
                <td>${pos.tp ? pos.tp.toFixed(2) : '--'}</td>
                <td style="color: ${pos.pnl >= 0 ? 'var(--buy-color)' : 'var(--sell-color)'}">${pos.pnl.toFixed(2)}</td>
                <td><button class="close-pos-btn" data-id="${pos.id}">X</button></td>
            `;
            row.querySelector('.close-pos-btn').onclick = () => closePosition(pos.id);
        });
    }
    
    function handleStepButtonClick(e) {
        const target = e.target.closest('.step-button');
        if (!target) return;
        const input = document.getElementById(target.dataset.input);
        const step = parseFloat(target.dataset.step);
        if (input && ohlcData[currentIndex]) {
            let val = parseFloat(input.value) || ohlcData[currentIndex].close;
            input.value = (val + step * 0.5).toFixed(2);
        }
    }

    const tutorialSteps = [
        { id: 'challenge-info', text: '這裡是您的帳戶資訊，目標是透過交易來增加淨值。' },
        { id: 'chart-canvas', text: '這是黃金(XAUUSD)的走勢圖，您可以拖曳平移、滾輪縮放。' },
        { id: 'playback-controls', text: '您可以使用這些按鈕來控制時間流逝，播放、暫停或加速。' },
        { id: 'bottom-panel', text: '這是交易面板。點擊「下一步」來學習如何下單。' },
        { id: 'sell-btn', text: '如果您認為價格會下跌，點擊「賣出」。' },
        { id: 'buy-btn', text: '如果您認為價格會上漲，點擊「買入」。祝您好運！' }
    ];

    function showTutorialStep(stepIndex) {
        const overlay = document.getElementById('tutorial-overlay');
        if (stepIndex >= tutorialSteps.length) {
            overlay.style.display = 'none'; return;
        }
        tutorialStep = stepIndex;
        const step = tutorialSteps[stepIndex];
        const element = document.getElementById(step.id);
        if (!element) { showTutorialStep(stepIndex + 1); return; }
        
        overlay.style.display = 'block';
        const rect = element.getBoundingClientRect();
        const highlight = document.getElementById('tutorial-highlight');
        const box = document.getElementById('tutorial-box');
        highlight.style.top = `${rect.top - 5}px`;
        highlight.style.left = `${rect.left - 5}px`;
        highlight.style.width = `${rect.width + 10}px`;
        highlight.style.height = `${rect.height + 10}px`;
        document.getElementById('tutorial-text').textContent = step.text;
        
        box.style.top = (rect.bottom + 15 + box.offsetHeight > window.innerHeight) ? `${rect.top - box.offsetHeight - 15}px` : `${rect.bottom + 15}px`;
        box.style.left = `${Math.max(5, rect.left + rect.width / 2 - box.offsetWidth / 2)}px`;
    }
    
    function showEndCard() {
        const card = document.getElementById('end-card');
        const equityEl = document.getElementById('final-equity');
        equityEl.textContent = `$${account.equity.toFixed(2)}`;
        equityEl.className = account.equity >= 10000 ? 'final-profit profit-positive' : 'final-profit profit-negative';
        card.style.display = 'flex';
    }

    document.addEventListener('DOMContentLoaded', () => {
        chart = new TradingChart('chart-canvas');
        document.getElementById('play-pause-btn').addEventListener('click', playPause);
        document.getElementById('next-candle-btn').addEventListener('click', () => { pauseGame(); nextCandle(); });
        document.getElementById('speed-selector').addEventListener('change', (e) => setSpeed(e.target.value));
        document.getElementById('buy-btn').addEventListener('click', () => openPosition('buy'));
        document.getElementById('sell-btn').addEventListener('click', () => openPosition('sell'));
        document.querySelectorAll('.tab-button').forEach(b => b.addEventListener('click', () => switchTab(b.dataset.tab)));
        document.getElementById('trade-panel').addEventListener('click', handleStepButtonClick);
        document.getElementById('tutorial-next-btn').addEventListener('click', () => showTutorialStep(tutorialStep + 1));
        document.getElementById('cta-button').addEventListener('click', (e) => { e.preventDefault(); window.open(e.target.href, '_blank'); });
        loadDataAndStart();
    });
    </script>
</body>
</html>
