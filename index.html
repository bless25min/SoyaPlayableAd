<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>反轉分析線訓練 Playable — 真實數據版</title>
<style>
  :root{--bg:#0f1220;--panel:#14192b;--text:#e9ecf4;--muted:#9aa3b2;--accent:#52d3a8;--bad:#ff6b6b;--good:#79e0ab;--grid:#ffffff14}
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  body{margin:0;background:#0f1220;color:var(--text)}
  .wrap{max-width:1180px;margin:0 auto;padding:12px}
  .toolbar{display:flex;align-items:center;gap:8px;background:#0c1222;border:1px solid #ffffff14;border-radius:10px;padding:8px 10px;box-shadow:0 6px 18px #00000040}
  .toolbar .btn{padding:6px 10px;border-radius:8px;border:1px solid #ffffff1f;background:#0f1a2e;color:#dfe6ff;cursor:pointer}
  .toolbar .seg{display:flex;border:1px solid #ffffff1f;border-radius:8px;overflow:hidden}
  .toolbar .seg button{border:0;background:#0f1a2e;color:#dfe6ff;padding:6px 10px}
  .toolbar .seg button.active{background:#182647}
  .sp{flex:1}
  .layout{display:grid;grid-template-columns:220px 1fr;gap:10px;margin-top:10px}
  .market{background:var(--panel);border:1px solid #ffffff14;border-radius:10px;padding:10px}
  .market h3{font-size:13px;margin:0 0 8px;color:#cbd6ff}
  .quote{display:flex;justify-content:space-between;padding:6px 8px;border-radius:8px;background:#0e1428;margin-bottom:6px}
  .quote small{color:#a8b2d1}
  #chartWrap{position:relative;background:#0b0f1d;border:1px solid rgba(255,255,255,.08);border-radius:12px;min-height:560px}
  #chart{width:100%;height:560px;display:block}
  .priceAxis{position:absolute;right:6px;top:6px;bottom:36px;width:70px;pointer-events:none}
  .priceAxis .tick{position:absolute;right:0;color:#cfe0ff;font-size:11px;transform:translateY(-50%)}
  .timeAxis{position:absolute;left:8px;right:8px;bottom:6px;height:24px;color:#bfc9e6;font-size:11px}
  .timeAxis .tick{position:absolute;bottom:0;transform:translateX(-50%)}
  .sigBanner{position:absolute;right:14px;bottom:14px;background:#0e1426;border:1px solid #ffffff22;border-radius:12px;padding:10px 12px;box-shadow:0 12px 28px #00000066;display:flex;gap:10px;align-items:center}
  .sigBanner .count{width:56px;height:6px;background:#ffffff22;border-radius:999px;overflow:hidden}
  .sigBanner .bar{height:100%;width:100%;background:#52d3a8}
  .sigBanner .actions button{border:0;border-radius:10px;padding:8px 10px;font-weight:700;cursor:pointer}
  .sigBanner .enter{background:var(--accent);color:#06291b}
  .sigBanner .skip{background:transparent;border:1px solid #ffffff3a;color:#e9ecf4}
  .orderDock{display:flex;gap:10px;align-items:center;background:#0e1426;border:1px solid #ffffff22;border-radius:12px;padding:10px 12px;box-shadow:0 12px 28px #00000033;margin-top:8px}
  .orderDock input{width:90px;background:#0f1a2e;border:1px solid #ffffff24;border-radius:8px;padding:6px 8px;color:#e9ecf4}
  .orderDock .btn{border:0;border-radius:10px;padding:8px 10px;font-weight:700;cursor:pointer}
  .orderDock .buy{background:#79e0ab;color:#06291b}
  .orderDock .sell{background:#ff9b9b;color:#2a0c0c}
  .alertLog{margin-top:10px;background:#0c1428;border:1px solid #ffffff14;border-radius:10px;padding:8px}
  .alertLog table{width:100%;border-collapse:collapse;font-size:12px}
  .alertLog th,.alertLog td{border-bottom:1px dashed #ffffff14;padding:6px 6px;text-align:left;color:#cfe0ff}
  .alertLog th{color:#9fb3ff}
  .trade{margin-top:10px;background:#0c1428;border:1px solid #ffffff14;border-radius:10px;padding:8px}
  .trade .row{display:flex;gap:16px;flex-wrap:wrap}
  .tag{font-size:12px;border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:4px 8px;color:#cfe0ff;background:#0c1428}
  .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#0e1426;color:#dfe6ff;border:1px solid rgba(255,255,255,.12);padding:10px 14px;border-radius:999px;box-shadow:0 8px 30px rgba(0,0,0,.35);font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <div class="seg" id="tfSeg">
      <button data-tf="M5">M5</button>
      <button data-tf="M15" class="active">M15</button>
    </div>
    <div class="seg" id="modeSeg">
      <button data-mode="SHORT_ONLY" class="active">空訓練</button>
      <button data-mode="LONG_ONLY">多訓練</button>
    </div>
    <button class="btn" id="btnPlay">播放/暫停 (Space)</button>
    <button class="btn" id="btnStep">逐K (→)</button>
    <button class="btn" id="btnLive">回到最新(F)</button>
    <button class="btn" id="btnLocal">載入本機CSV</button><input type="file" id="fileCSV" accept=".csv,text/csv" style="display:none"/>
    <div class="seg" id="spdSeg">
      <button data-spd="900">慢</button>
      <button data-spd="650" class="active">中</button>
      <button data-spd="400">快</button>
    </div>
    <div class="sp"></div>
    <span class="tag" id="hudInfo">—</span>
  </div>

  <div class="layout">
    <aside class="market">
      <h3>Market Watch</h3>
      <div class="quote"><b>XAUUSD</b><span><small>Bid</small> <b id="qBid">—</b> / <small>Ask</small> <b id="qAsk">—</b></span></div>
    </aside>

    <main id="chartCol">
      <div id="chartWrap">
        <canvas id="chart"></canvas>
        <div class="priceAxis" id="priceAxis"></div>
        <div class="timeAxis" id="timeAxis"></div>
      </div>
        <div class="orderDock">
          <div style="font-weight:700;margin-right:6px">下單</div>
          <small>SL價</small><input id="inSL" type="number"/>
          <small>TP價</small><input id="inTP" type="number"/>
          <small>掛單價</small><input id="inPend" type="number"/>
          <button class="btn buy" id="btnBuyNow">立即買入</button>
          <button class="btn sell" id="btnSellNow">立即賣出</button>
          <button class="btn buy" id="btnBuyPend">掛單買入</button>
          <button class="btn sell" id="btnSellPend">掛單賣出</button>
          <button class="btn" id="btnCloseAll">平倉全部</button>
          <small id="posInfo" style="margin-left:6px;color:#9fb0cf">無倉位</small>
        </div>
  </main>
  </div>

  <section class="trade">
    <div class="row">
      <span class="tag">今日訊號：<b id="hudSig">0</b></span>
      <span class="tag">已判斷：<b id="hudDec">0</b></span>
      <span class="tag">可見K：<b id="hudVis">0</b></span>
      <span class="tag">規則：正確僅有一筆（收上/收下分析線）</span>
      <span class="tag">浮動損益：<b id="hudPnL">0R / $0</b></span>
    </div>
  </section>

  <section class="alertLog">
    <table>
      <thead><tr><th style="width:80px">時間</th><th style="width:60px">週期</th><th style="width:60px">方向</th><th>說明</th><th style="width:120px">分析線價</th><th style="width:80px">正確?</th></tr></thead>
      <tbody id="logBody"></tbody>
    </table>
  </section>
</div>

<script>
// ===== Config =====
const CONFIG = {
  symbol: "XAUUSD",
  timeframe: "M15",
  playSpeed: 650,
  startHistoryRatio: 0.6,
  windowBars: 120,
  rrMin: 2,
  rrThreshold: 1.5,
  signalsMin: 3,
  signalsMax: 5,
  fibKeys:[0.236,0.382,0.5,0.618,0.786],     // 只用於計算分析線，不顯示任何文字
};

// ===== State =====
const state = {
  mode:"SHORT_ONLY",
  timeframe:CONFIG.timeframe,
  playSpeed:CONFIG.playSpeed,
  bars:[],
  sigs:[],
  visible:0,
  timer:null,
  analysisLine:null,
  dataset:[],
  view:{scaleX:1, offsetBar:0, userPanned:false, followTail:true},
  positions:[],
  orders:[],
  trades:[],
  decisions:[]
};
const el=id=>document.getElementById(id);
let realizedPnL = 0;
function toast(msg,ms=1200){const t=document.createElement('div');t.className='toast';t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),ms);}

// ===== CSV loader =====
function qs(name){ return new URLSearchParams(location.search).get(name); }
function guessGitHubRaw(){
  if(location.hostname.endsWith('github.io')){
    const owner = location.hostname.split('.')[0];
    const repo = location.pathname.split('/').filter(Boolean)[0] || '';
    if(repo){
      return [
        `${location.protocol}//${location.host}/${repo}/XAUUSD_M15.csv`,
        `https://raw.githubusercontent.com/${owner}/${repo}/main/XAUUSD_M15.csv`,
        `https://raw.githubusercontent.com/${owner}/${repo}/master/XAUUSD_M15.csv`
      ];
    }
  }
  return [];
}
function candidateCSVUrls(){
  const q = qs('csv');
  const list = [];
  if(q) list.push(q);
  list.push('XAUUSD_M15.csv','./XAUUSD_M15.csv','/XAUUSD_M15.csv');
  list.push(...guessGitHubRaw());
  return list;
}
async function loadFirstCSV(){
  const urls = candidateCSVUrls();
  for(const u of urls){
    try{
      const r = await fetch(u, {cache:'no-store', mode:'cors'});
      if(r.ok){
        const text = await r.text();
        const rows = parseOHLC(text);
        if(rows.length >= 100){
          console.log('CSV loaded:', u, rows.length);
          return rows;
        }
      }
    }catch(e){ console.warn('fetch failed', u, e); }
  }
  return [];
}
function parseOHLC(text){
  if(!text) return [];
  // 去 BOM
  if(text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
  const lines = text.split(/\r?\n/).filter(l => l && !/^#/.test(l));
  if(lines.length < 2) return [];

  // 自動偵測分隔符：; / , / \t
  const first = lines.find(l => /[0-9]/.test(l)) || lines[0];
  let delim = ',';
  if(first.includes(';')) delim = ';';
  else if(first.includes('\t')) delim = '\t';

  // 若第一行是表頭，抓欄位索引
  const hdrLower = lines[0].toLowerCase();
  const hasHeader = /(time|date)/.test(hdrLower) && /(open|high|low|close)/.test(hdrLower);
  const cols = hasHeader ? hdrLower.split(delim) : null;
  const idx = (k)=> hasHeader ? cols.findIndex(x=>x.includes(k)) : -1;

  const out = [];
  for(let n = hasHeader?1:0; n < lines.length; n++){
    const a = lines[n].split(delim).map(s => s.trim());
    if(a.length < 5) continue;

    let dt, o, h, l, c;

    // ①「日期+時間在同一欄」：YYYY.MM.DD HH:MM[:SS]
    if(/^\d{4}[-./]\d{2}[-./]\d{2}\s+\d{1,2}:\d{2}(:\d{2})?$/.test(a[0])){
      dt = a[0].replace(/[.]/g,'-');
      o = parseFloat(a[1]); h = parseFloat(a[2]); l = parseFloat(a[3]); c = parseFloat(a[4]);
    }
    // ②「日期、時間分兩欄」：YYYY.MM.DD, HH:MM, O,H,L,C
    else if(/^\d{4}[-./]\d{2}[-./]\d{2}$/.test(a[0]) && /^\d{1,2}:\d{2}(:\d{2})?$/.test(a[1])){
      dt = a[0].replace(/[.]/g,'-') + ' ' + a[1];
      o = parseFloat(a[2]); h = parseFloat(a[3]); l = parseFloat(a[4]); c = parseFloat(a[5]);
    }
    // ③ 表頭索引：Time/Open/High/Low/Close
    else if(hasHeader){
      const ti = idx('time')>-1 ? idx('time') : idx('date');
      dt = (a[ti] || '').replace(/[.]/g,'-');
      o = parseFloat(a[idx('open')]); h = parseFloat(a[idx('high')]);
      l = parseFloat(a[idx('low')]);  c = parseFloat(a[idx('close')]);
    }else{
      continue; // 不認得的格式
    }

    if(!isFinite(o)||!isFinite(h)||!isFinite(l)||!isFinite(c)) continue;
    out.push({ t: new Date(dt), o, h, l, c });
  }

  out.sort((x,y)=>x.t - y.t);
  return out;
}

// ===== Pick a contiguous session (no weekend gaps) =====
function pickSession(data, minutesPerBar){
  const step = minutesPerBar*60*1000;
  const aim  = (state.timeframe==='M15')?96:288; // 不足時取最長片段

  let segments=[], longest=[], i=0;
  while (i < data.length) {
    let seg = [data[i++]];
    while (i < data.length && (data[i].t - seg[seg.length-1].t) === step) {
      seg.push(data[i++]);
    }
    if (seg.length > longest.length) longest = seg;
    segments.push(seg);
  }
  if (!segments.length) return [];

  const pool = segments.filter(s => s.length >= aim);
  const base = pool.length ? pool : [longest];

  // 方向過濾（空：先漲；多：先跌）—若無候選則回退
  const dir  = state.mode==='SHORT_ONLY' ? +1 : -1;
  const filt = base.filter(s => dir * (s[Math.floor(s.length*0.3)].c - s[0].c) > 0);
  const take = filt.length ? filt : base;

  return take[Math.floor(Math.random()*take.length)];
}

// ===== Build bars & signals from real session =====
function buildFromSession(seg){
  const bars = seg.map((b,i)=>({
    t: `${String(b.t.getHours()).padStart(2,'0')}:${String(b.t.getMinutes()).padStart(2,'0')}`,
    o: i ? seg[i-1].c : b.o, h:b.h, l:b.l, c:b.c
  }));

  // 分析線：優先用你的清單，沒有才 fallback Fib
  let line = null;
  if (state.mode==='SHORT_ONLY' && CONFIG.strategyLines?.short?.length) {
    line = CONFIG.strategyLines.short[Math.floor(Math.random()*CONFIG.strategyLines.short.length)];
  } else if (state.mode==='LONG_ONLY' && CONFIG.strategyLines?.long?.length) {
    line = CONFIG.strategyLines.long[Math.floor(Math.random()*CONFIG.strategyLines.long.length)];
  }
  if (!line) {
    const head = bars.slice(0, Math.floor(bars.length*0.4));
    const hi = Math.max(...head.map(b=>b.h)), lo = Math.min(...head.map(b=>b.l));
    const up = head[head.length-1].c > head[0].c;
    const fibs = [0.236,0.382,0.5,0.618,0.786].map(k => up ? (lo+k*(hi-lo)) : (hi-k*(hi-lo)));
    line = fibs[Math.floor(Math.random()*fibs.length)];
  }

  state.analysisLine = line;
  state.bars = bars;
  state.sigs = [];

  // 初始顯示一定小於總長，避免一播放就到尾端
  const target = Math.floor(state.bars.length * (CONFIG.startHistoryRatio || 0.6));
  state.visible = Math.max(30, Math.min(state.bars.length - 5, target));

  // 視圖狀態
  state.view.offsetBar = 0;
  state.view.userPanned = false;
  state.view.followTail = true;

  // 清空交易狀態
  state.positions = [];
  state.orders    = [];
  state.trades    = [];
  state.decisions = [];
}

function currentWindow(){
  const total = state.bars.length;
  const right = Math.max(1, Math.min(state.visible, total));  // 目前推到第幾根（1-based）
  const win   = Math.max(60, Math.floor((CONFIG.windowBars||120) / (state.view.scaleX||1)));

  let start, end;

  if (state.view.followTail) {
    // 跟隨最新：若可視根數還比視窗窄，就顯示 [0, right]；不固定視窗寬
    if (right <= win || total <= win) {
      start = 0;
      end   = right;                 // <-- 隨 right 增加而推進
    } else {
      start = right - win;           // <-- 貼右緣滾動
      end   = right;
    }
  } else {
    // 使用者平移：允許看完整段歷史
    start = Math.max(0, Math.min(total - win, right - win + (state.view.offsetBar||0)));
    end   = Math.min(total, start + win);
  }
  return { start, end, win, right, total };
}

// ===== Rendering =====
const canvas=el('chart'); const pxAxis=el('priceAxis'); const tmAxis=el('timeAxis');
let pan=false, lastX=0;
function draw(){
  const ctx = canvas.getContext('2d'); const W = canvas.width = canvas.clientWidth; const H = canvas.height = canvas.clientHeight;
  ctx.clearRect(0,0,W,H);
  const {start,end} = currentWindow();
  const data=state.bars.slice(start,end);
  if(!data.length) return;
  const hi = Math.max(...data.map(b=>b.h), state.analysisLine||-Infinity);
  const lo = Math.min(...data.map(b=>b.l), state.analysisLine||Infinity);
  const pad=(hi-lo)*0.12||5, yMax=hi+pad, yMin=lo-pad; const xStep=W/Math.max(48,data.length+2); const y=v=>H-(v-yMin)/(yMax-yMin)*H;
  // grid
  const step=state.timeframe==='M15'?4:12; ctx.strokeStyle='var(--grid)'; for(let i=0;i<6;i++){const yv=H*i/5; ctx.beginPath(); ctx.moveTo(0,yv); ctx.lineTo(W,yv); ctx.stroke();} ctx.setLineDash([3,6]); for(let i=0;i<data.length;i+=step){const x=24+i*xStep; ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();} ctx.setLineDash([]);
  // analysis line（不顯示任何費波文字，只顯示價格）
  if(state.analysisLine){ ctx.setLineDash([4,4]); ctx.strokeStyle='rgba(190,210,120,.95)'; const yL=y(state.analysisLine); ctx.beginPath(); ctx.moveTo(0,yL); ctx.lineTo(W,yL); ctx.stroke(); ctx.setLineDash([]); ctx.fillStyle='rgba(190,210,120,.95)'; ctx.font='12px system-ui'; ctx.fillText(state.analysisLine.toFixed(2), W-70, yL-6); }
  // candles
  for(let i=0;i<data.length;i++){const b=data[i], x=24+i*xStep, up=b.c>=b.o; ctx.strokeStyle=up?'rgba(140,220,180,.9)':'rgba(255,130,130,.9)'; ctx.fillStyle=up?'rgba(140,220,180,.25)':'rgba(255,130,130,.25)'; ctx.beginPath(); ctx.moveTo(x,y(b.h)); ctx.lineTo(x,y(b.l)); ctx.stroke(); const w=Math.max(3,xStep*0.6), y1=y(b.o), y2=y(b.c); ctx.fillRect(x-w/2, Math.min(y1,y2), w, Math.max(2,Math.abs(y1-y2))); }
  // manual positions
  state.positions.forEach((p,idx)=>{
    const color=p.side==='LONG'?'#79e0ab':'#ff9b9b';
    ctx.strokeStyle=color; ctx.setLineDash([5,4]);
    ctx.beginPath(); ctx.moveTo(0,y(p.entry)); ctx.lineTo(W,y(p.entry)); ctx.stroke();
    ctx.setLineDash([]); ctx.fillStyle=color; ctx.font='12px system-ui';
    ctx.fillText(`${p.side} @ ${p.entry.toFixed(2)} | ${p.pnlR.toFixed(2)}R / $${p.pnl$.toFixed(2)}`, 20, 28+14*idx);
  });
  // axes
  pxAxis.innerHTML=''; const ticks=6; for(let i=0;i<=ticks;i++){const v=yMin+(yMax-yMin)*i/ticks; const d=document.createElement('div'); d.className='tick'; d.style.top=`${H-(H*i/ticks)}px`; d.textContent=v.toFixed(2); pxAxis.appendChild(d);} tmAxis.innerHTML=''; const tStep=state.timeframe==='M15'?4:12; for(let i=0;i<data.length;i+=tStep){const d=document.createElement('div'); d.className='tick'; d.style.left=`${(24+i*xStep)}px`; d.textContent=data[i].t; tmAxis.appendChild(d);} 
}

canvas.addEventListener('mousedown', e => {
  pan = true; lastX = e.clientX;
  state.view.userPanned = true;
  state.view.followTail = false;  // 一旦拖曳就退出跟隨
});
window.addEventListener('mouseup', () => { pan = false; });

canvas.addEventListener('mousemove', e => {
  if (!pan) return;
  const dx = e.clientX - lastX; lastX = e.clientX;

  const { right, total } = currentWindow();
  const lower = -(right - 1);          // 最左能到第0根
  const upper = (total - right) - 1;   // 最右能到資料尾端
  const step  = dx>0 ? -1 : (dx<0 ? +1 : 0);

  state.view.offsetBar = Math.max(lower, Math.min(upper, (state.view.offsetBar||0) + step));
  draw();
});

// ===== HUD & Banners =====
function refreshHUD(){
  el('hudSig').textContent = state.sigs.length;
  el('hudDec').textContent = state.decisions.length;
  el('hudVis').textContent = `${state.visible}/${state.bars.length}`;
  el('hudInfo').textContent = `${CONFIG.symbol} • ${state.timeframe} • 模式 ${state.mode==='SHORT_ONLY'?'空':'多'}`;
  const last = state.bars[state.visible-1];
  if(last){
    el('qBid').textContent = last.c.toFixed(2);
    el('qAsk').textContent = (last.c+0.2).toFixed(2);
  }
  let unreal$ = 0, unrealR = 0;
  state.positions.forEach(p=>{ unreal$ += p.pnl$; unrealR += p.pnlR; });
  el('hudPnL').textContent = `浮動 ${unrealR.toFixed(2)}R / $${unreal$.toFixed(2)} ｜ 已實現 $${realizedPnL.toFixed(2)}`;
  el('posInfo').textContent = state.positions.length?`持倉 ${state.positions.length}`:'無倉位';
}
function pushAlertLog(sig){ const b=state.bars[sig.idx]; const tr=document.createElement('tr'); tr.innerHTML=`<td>${b.t}</td><td>${state.timeframe}</td><td>${state.mode==='SHORT_ONLY'?'空':'多'}</td><td>${sig.note}</td><td>${state.analysisLine?state.analysisLine.toFixed(2):''}</td><td>${sig.valid?'✅':'—'}</td>`; el('logBody').prepend(tr); }
let bannerTimer=null, bannerBar=null, bannerBox=null;
function showSignalBanner(sig){ if(bannerBox) bannerBox.remove(); const box=document.createElement('div'); box.className='sigBanner'; box.innerHTML=`<div style="font-size:13px">⚠️ 訊號：<b>${state.bars[sig.idx].t}</b><br><small>${sig.note}</small></div><div class="count"><div class="bar"></div></div><div class="actions"><button class="enter">E 進場</button> <button class="skip">S 放棄</button></div>`; document.getElementById('chartWrap').appendChild(box); bannerBox=box; bannerBar=box.querySelector('.bar'); let t=5, step=20, total=t*1000/step, i=0; clearInterval(bannerTimer); bannerTimer=setInterval(()=>{ i++; bannerBar.style.width=`${100-Math.min(100, i/total*100)}%`; if(i>=total){ clearInterval(bannerTimer); box.remove(); recordDecision(sig,'timeout'); } }, step); box.querySelector('.enter').onclick=()=>{ clearInterval(bannerTimer); box.remove(); recordDecision(sig,'enter'); }; box.querySelector('.skip').onclick=()=>{ clearInterval(bannerTimer); box.remove(); recordDecision(sig,'skip'); }; }
function recordDecision(sig, action){
  if(state.decisions.find(d=>d.idx===sig.idx)) return;
  const correct = action==='enter' ? !!sig.valid : !sig.valid;
  state.decisions.push({idx:sig.idx, action, correct, type:sig.type, note:sig.note});
  if(action==='enter' && !sig.valid) { toast('❌ 這筆不該進場'); }
  refreshHUD();
}

// ===== Manual trading =====
function placeMarket(side){
  const last = state.bars[state.visible-1];
  if(!last) return;
  const bid = last.c, ask = bid+0.2, mid=(bid+ask)/2;
  const entry = side==='LONG'?ask:bid;
  const sl = parseFloat(el('inSL').value) || null;
  const tp = parseFloat(el('inTP').value) || null;
  state.positions.push({side, entry, sl, tp, size:1, pnl$:0, pnlR:0, midOpen:mid});
  refreshHUD();
}
function placePending(side){
  const last = state.bars[state.visible-1];
  if(!last) return;
  const bid=last.c, ask=bid+0.2;
  const price=parseFloat(el('inPend').value); if(isNaN(price)) return;
  const sl=parseFloat(el('inSL').value)||null;
  const tp=parseFloat(el('inTP').value)||null;
  let type;
  if(side==='LONG') type = price<bid ? 'LIMIT' : 'STOP';
  else type = price>ask ? 'LIMIT' : 'STOP';
  state.orders.push({side, price, sl, tp, type});
  refreshHUD();
}
function closeAll(){
  const last=state.bars[state.visible-1]; if(!last) return;
  const bid=last.c, ask=bid+0.2;
  state.positions.forEach(p=>{
    const exit = p.side==='LONG'?bid:ask;
    const pnl = (p.side==='LONG'? exit - p.entry : p.entry - exit);
    realizedPnL += pnl;
  });
  state.positions=[];
  refreshHUD();
}

function updatePositions(){
  const last = state.bars[state.visible-1];
  if(!last) return;
  const bid=last.c, ask=bid+0.2, mid=(bid+ask)/2;
  // trigger orders
  for(let i=state.orders.length-1;i>=0;i--){
    const o=state.orders[i];
    const hit = o.side==='LONG' ? (o.type==='LIMIT'? bid<=o.price : ask>=o.price)
                                : (o.type==='LIMIT'? ask>=o.price : bid<=o.price);
    if(hit){
      state.positions.push({side:o.side, entry:o.price, sl:o.sl, tp:o.tp, size:1, pnl$:0, pnlR:0, midOpen:mid});
      state.orders.splice(i,1);
    }
  }
  // update positions
  for(let i=state.positions.length-1;i>=0;i--){
    const p=state.positions[i];
    const price = p.side==='LONG'?bid:ask;
    p.pnl$ = (p.side==='LONG'? price - p.entry : p.entry - price);
    const risk = p.sl!=null ? Math.abs(p.entry - p.sl) : Math.abs(p.entry - p.midOpen);
    p.pnlR = risk>0 ? p.pnl$ / risk : 0;
    const hitTP = p.tp!=null && ((p.side==='LONG' && price>=p.tp) || (p.side==='SHORT' && price<=p.tp));
    const hitSL = p.sl!=null && ((p.side==='LONG' && price<=p.sl) || (p.side==='SHORT' && price>=p.sl));
    if(hitTP || hitSL){
      const exit = hitTP? p.tp : p.sl;
      const pnl = (p.side==='LONG'? exit - p.entry : p.entry - exit);
      realizedPnL += pnl;
      state.positions.splice(i,1);
    }
  }
  refreshHUD();
}

// ===== Playback =====
function togglePlay(force){ const playing=!!state.timer; if(playing && !force){ clearInterval(state.timer); state.timer=null; toast('暫停'); return;} if(!playing){ state.timer=setInterval(stepOnce,state.playSpeed); toast('播放中…'); }}
function stepOnce(){
  if(state.visible >= state.bars.length){
    clearInterval(state.timer); state.timer=null; return;
  }
  state.visible++;
  if (state.view.followTail) {
    state.view.userPanned = false;
    state.view.offsetBar  = 0;   // 一律貼右緣
  }
  draw();
  const sig=state.sigs.find(s=>s.idx===state.visible-1);
  if(sig){ pushAlertLog(sig); showSignalBanner(sig); }
  updatePositions();
  refreshHUD();
}

// ===== Boot / Reset =====
async function boot(){ state.dataset = await loadFirstCSV(); if(state.dataset.length===0){ console.error('無法載入CSV，請放到同目錄、以 ?csv= 指定，或用「載入本機CSV」按鈕。'); }
  reset(); }
function reset(){ clearInterval(state.timer); state.timer=null; state.visible=0; state.decisions=[]; state.positions=[]; state.orders=[]; state.trades=[]; el('logBody').innerHTML='';
  state.view.offsetBar = 0;
  state.view.userPanned = false;
  state.view.followTail = true;
  const minutesPerBar = state.timeframe==='M15'?15:5;
  if(state.dataset.length){ const session = pickSession(state.dataset, minutesPerBar); if(session.length){ buildFromSession(session); draw(); refreshHUD(); return; } }
  // fallback：若無資料
  state.bars=[]; state.sigs=[]; draw(); refreshHUD(); toast('請提供 M15 CSV'); }

['tfSeg','modeSeg','spdSeg'].forEach(id=>el(id).addEventListener('click',e=>{ if(e.target.tagName!=='BUTTON')return; [...e.currentTarget.children].forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); if(id==='tfSeg'){ state.timeframe=e.target.dataset.tf; } if(id==='modeSeg'){ state.mode=e.target.dataset.mode; } if(id==='spdSeg'){ state.playSpeed=parseInt(e.target.dataset.spd,10); } reset(); }));

el('btnPlay').onclick=()=>togglePlay();
el('btnStep').onclick=()=>stepOnce();
function goLive(){
  state.view.offsetBar = 0;
  state.view.userPanned = false;
  state.view.followTail = true;
  draw();
}
document.getElementById('btnLive').onclick = goLive;
window.addEventListener('keydown', e => { if(e.key.toLowerCase()==='f') goLive(); });

document.getElementById('btnLocal').onclick = () => document.getElementById('fileCSV').click();
document.getElementById('fileCSV').addEventListener('change', (e) => {
  const f = e.target.files && e.target.files[0];
  if(!f){ toast('未選擇檔案'); return; }
  const fr = new FileReader();
  fr.onload = (ev) => {
    const text = ev.target.result;
    const rows = parseOHLC(text);
    if(rows.length < 100){ toast('CSV 格式不符或資料太少'); return; }
    state.dataset = rows;
    reset(); // 直接用本機資料建模
    toast(`已載入本機 CSV：${rows.length} 筆`);
  };
  fr.readAsText(f, 'utf-8');
});
window.addEventListener('keydown',e=>{ if(e.code==='Space'){e.preventDefault();togglePlay();} if(e.code==='ArrowRight'){stepOnce();} if(e.key==='1'){document.querySelector('#tfSeg [data-tf="M5"]').click();} if(e.key==='2'){document.querySelector('#tfSeg [data-tf="M15"]').click();} if(e.key==='+'){state.playSpeed=Math.max(200,state.playSpeed-100);} if(e.key==='-'){state.playSpeed=Math.min(1200,state.playSpeed+100);} if(e.key.toLowerCase()==='e' && bannerBox){ bannerBox.querySelector('.enter').click(); } if(e.key.toLowerCase()==='s' && bannerBox){ bannerBox.querySelector('.skip').click(); } });

el('btnBuyNow').onclick=()=>placeMarket('LONG');
el('btnSellNow').onclick=()=>placeMarket('SHORT');
el('btnBuyPend').onclick=()=>placePending('LONG');
el('btnSellPend').onclick=()=>placePending('SHORT');
el('btnCloseAll').onclick=()=>closeAll();

boot();
</script>
</body>
</html>
