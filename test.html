<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>交易模擬遊戲</title>
<style>
:root {
  /* --- 遊戲化深色主題 --- */
  --bg: #1a1e2b;
  --panel: #2a2f42;
  --panel-soft: #242838;
  --text: #eef3ff;
  --muted: #8a93b0;
  --border-color: #4b5169;
  --accent: #4a72ff;
  --accent2: #2aa3ff;
  --good: #28c782;
  --danger: #ff5f6d;
  --warn: #ffcc57;
  --grid: rgba(75, 81, 105, 0.5);
  --k-up-stroke: var(--good);
  --k-up-fill: rgba(40, 199, 130, 0.3);
  --k-down-stroke: var(--danger);
  --k-down-fill: rgba(255, 95, 109, 0.3);
}

* { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }

body {
  margin: 0;
  background-color: var(--bg);
  color: var(--text);
  font-size: 14px;
}

.wrap { max-width: 1280px; margin: 0 auto; padding: 16px; }

/* --- 工具列 --- */
.toolbar {
  display: flex;
  align-items: center;
  gap: 10px;
  background-color: var(--panel);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 10px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}

.btn {
  border-radius: 8px;
  background: linear-gradient(180deg, #3c4257, #2a2f42);
  border: 1px solid var(--border-color);
  color: var(--text);
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  padding: 8px 14px;
  cursor: pointer;
  transition: transform 0.1s ease, box-shadow 0.2s ease, background 0.2s ease;
  font-weight: 500;
}
.btn:hover { background: linear-gradient(180deg, #4b5169, #3c4257); }
.btn:active { transform: translateY(1px); box-shadow: 0 1px 2px rgba(0,0,0,0.2); }

.btn.buy { background: linear-gradient(180deg, #28c782, #1fa869); border-color: #167a4c; }
.btn.sell { background: linear-gradient(180deg, #ff5f6d, #e64a57); border-color: #b33a44; }

.toolbar .seg { display: flex; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
.toolbar .seg button { border: 0; background: none; color: var(--muted); padding: 8px 12px; }
.toolbar .seg button.active { background: var(--accent); color: white; }
.sp { flex: 1; }

/* --- 主佈局 --- */
.layout { display: grid; grid-template-columns: 240px 1fr; gap: 16px; margin-top: 16px; }
.market { background: var(--panel); border: 1px solid var(--border-color); border-radius: 12px; padding: 12px; }
.market h3 { font-size: 14px; margin: 0 0 10px; color: var(--muted); font-weight: 600; }
.quote { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-radius: 8px; background: var(--panel-soft); margin-bottom: 8px; }
.quote small { color: var(--muted); }

#chartWrap { position: relative; background: var(--panel-soft); border: 1px solid var(--border-color); border-radius: 12px; min-height: 560px; overflow: hidden; }
#chart { width: 100%; height: 560px; display: block; }
.priceAxis { position: absolute; right: 8px; top: 8px; bottom: 40px; width: 70px; pointer-events: none; }
.priceAxis .tick { position: absolute; right: 0; color: var(--muted); font-size: 12px; transform: translateY(-50%); }
.timeAxis { position: absolute; left: 8px; right: 8px; bottom: 8px; height: 24px; color: var(--muted); font-size: 12px; }
.timeAxis .tick { position: absolute; bottom: 0; transform: translateX(-50%); }
.event-marker { position: absolute; bottom: 22px; transform: translateX(-50%); font-size: 16px; cursor: pointer; }
.tooltip { position: fixed; background: var(--panel); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 8px; z-index: 1000; display: none; font-size: 12px; max-width: 200px; }

/* --- 下單面板 --- */
.orderDock {
  background: var(--panel);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 12px;
  align-items: center;
  padding: 16px;
  box-shadow: 0 12px 28px rgba(0,0,0,0.2);
  margin-top: 16px;
}
.orderDock .input-group { display: flex; flex-direction: column; }
.orderDock .input-group label { font-size: 12px; color: var(--muted); margin-bottom: 4px; }
.orderDock input { width: 100%; background: var(--panel-soft); border: 1px solid var(--border-color); border-radius: 8px; padding: 8px 10px; color: var(--text); }
.orderDock .btn-group { grid-column: 1 / -1; display: flex; gap: 12px; }
.orderDock .btn-group .btn { flex: 1; }
.orderDock .tag { grid-column: 1 / -1; }

.tag { font-size: 12px; background: var(--panel-soft); border: 1px solid var(--border-color); color: var(--muted); border-radius: 8px; padding: 6px 10px; text-align: center; }

/* --- 底部面板 --- */
.panel { background: var(--panel); border: 1px solid var(--border-color); border-radius: 12px; padding: 8px; margin-top: 16px; }
.panel table { width: 100%; border-collapse: collapse; font-size: 13px; }
.panel th, .panel td { border-bottom: 1px solid var(--border-color); padding: 8px; text-align: left; }
.panel th { color: var(--muted); font-weight: 500; }
.panel td .pnl-up { color: var(--good); }
.panel td .pnl-down { color: var(--danger); }
.panel td .pnl-neutral { color: var(--muted); }

.toast { position: fixed; left: 50%; bottom: 20px; transform: translateX(-50%); background: var(--panel); color: var(--text); border: 1px solid var(--border-color); padding: 12px 18px; border-radius: 8px; box-shadow: 0 8px 30px rgba(0,0,0,0.2); font-size: 14px; z-index: 10000; }

/* --- 動畫效果 --- */
.profitPulse { animation: pulse .8s ease-out; }
.lossShake { animation: shake .5s ease-in-out; }
@keyframes pulse {
  0% { box-shadow: 0 0 0 0 var(--good); }
  100% { box-shadow: 0 0 0 22px rgba(40, 199, 130, 0); }
}
@keyframes shake {
  10%, 90% { transform: translateX(-2px); } 20%, 80% { transform: translateX(4px); }
  30%, 50%, 70% { transform: translateX(-7px); } 40%, 60% { transform: translateX(7px); }
}

#confetti { position: fixed; inset: 0; pointer-events: none; z-index: 9999; }

/* --- 教學與彈窗 --- */
.tour-mask { position: fixed; inset: 0; background: rgba(0,0,0,.7); backdrop-filter: blur(4px); z-index: 9997; }
.tour-tip { position: fixed; padding: 14px; background: var(--panel); color: var(--text); border: 1px solid var(--border-color); border-radius: 12px; z-index: 9998; max-width: 280px; box-shadow: 0 8px 28px rgba(0,0,0,.35); }
.tour-tip .next { margin-top: 10px; display: inline-block; background: var(--accent); color: white; border: 0; padding: 8px 12px; border-radius: 8px; }
.tour-hi { position: relative; z-index: 9999; box-shadow: 0 0 0 4px var(--accent2); border-radius: inherit; }

/* --- 響應式設計 --- */
@media (max-width: 960px) {
  .layout { grid-template-columns: 1fr; }
  .market { order: 2; }
  .bottom { grid-template-columns: 1fr; }
}
@media (max-width: 768px) {
  .wrap { padding: 8px; }
  .toolbar { flex-wrap: wrap; }
  #chartWrap { min-height: 40vh; }
  .orderDock { grid-template-columns: 1fr 1fr; }
  .orderDock .input-group { grid-column: span 1; }
  .orderDock .btn-group { grid-column: 1 / -1; flex-direction: column; }
}

</style>
</head>
<body>
<div id="confetti"></div>
<div class="wrap">
  <div class="toolbar">
    <button class="btn" id="btnPlay">播放/暫停 (Space)</button>
    <button class="btn" id="btnStep">逐K (→)</button>
    <button class="btn" id="btnLive">回到最新(F)</button>
    <div class="seg" id="spdSeg">
      <button data-spd="900">慢</button>
      <button data-spd="650" class="active">中</button>
      <button data-spd="400">快</button>
    </div>
    <div class="sp"></div>
    <label class="tag">可視K數 <input id="barsRange" type="range" min="120" max="320" value="200" style="vertical-align:middle;"></label>
    <label class="tag">圖高 <input id="hRange" type="range" min="360" max="820" value="560" style="vertical-align:middle;"></label>
    <button class="btn" id="btnReroll">重新隨機開始</button>
    <button class="btn" id="btnPath">技能樹</button>
    <button class="btn" id="btnGuide">新手教學</button>
    <span class="tag" id="hudInfo">XAUUSD M15</span>
  </div>

  <div id="pathPanel" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); backdrop-filter: blur(4px); z-index:9997;">
    <div style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(92vw,520px); background:var(--panel); border:1px solid var(--border-color); border-radius:16px; padding:14px;">
      <div style="font-weight:800; margin-bottom:8px">Trader Path 技能樹</div>
      <div id="pathGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;"></div>
      <div style="text-align:right;margin-top:8px"><button class="btn" id="btnPathClose">關閉</button></div>
    </div>
  </div>

  <div class="layout">
    <aside class="market">
      <h3>市場報價</h3>
      <div class="quote"><b>XAUUSD</b><span><small>買價</small> <b id="qBid">—</b> / <small>賣價</small> <b id="qAsk">—</b></span></div>
    </aside>

    <main id="chartCol">
      <div id="chartWrap">
        <canvas id="chart"></canvas>
        <div class="priceAxis" id="priceAxis"></div>
        <div class="timeAxis" id="timeAxis"></div>
        <div id="tooltip" class="tooltip"></div>
      </div>
      <div class="orderDock">
        <div class="input-group"><label for="lots">手數</label><input id="lots" type="number" value="1" min="0.01" step="0.01"></div>
        <div class="input-group"><label for="slPrice">停損價(SL)</label><input id="slPrice" type="number" placeholder="可選"></div>
        <div class="input-group"><label for="tpPrice">停利價(TP)</label><input id="tpPrice" type="number" placeholder="可選"></div>
        <div class="input-group"><label for="pendPrice">掛單價</label><input id="pendPrice" type="number" placeholder="可選"></div>
        <div class="btn-group">
            <button class="btn buy" id="btnBuyNow">立即買入</button>
            <button class="btn sell" id="btnSellNow">立即賣出</button>
            <button class="btn buy" id="btnPendBuy">掛單買入</button>
            <button class="btn sell" id="btnPendSell">掛單賣出</button>
        </div>
        <button class="btn" id="btnCloseAll" style="grid-column: 1 / -1;">平倉全部</button>
        <span class="tag" id="riskBuy">買入停損：$0.00</span>
        <span class="tag" id="riskSell">賣出停損：$0.00</span>
        <span class="tag" id="riskPend">掛單停損：$0.00</span>
      </div>
    </main>
  </div>

  <section class="bottom" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
    <div class="panel">
      <table>
        <thead><tr><th>方向</th><th>進場</th><th>SL</th><th>TP</th><th>手數</th><th>損益</th><th></th></tr></thead>
        <tbody id="posBody"></tbody>
      </table>
    </div>
    <div class="panel">
      <table>
        <thead><tr><th>時間</th><th>事件</th><th>方向</th><th>價位</th><th>手數</th><th>備註</th></tr></thead>
        <tbody id="journalBody"></tbody>
      </table>
    </div>
  </section>
</div>

<div id="tourMask" class="tour-mask" style="display:none"></div>
<div id="tourTip" class="tour-tip" style="display:none"></div>
<div id="ctaPanel" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); backdrop-filter: blur(4px); z-index:9996;">
  <div style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:300px; background:var(--panel); border:1px solid var(--border-color); border-radius:16px; padding:16px; text-align:center;">
    <div id="ctaInfo" style="margin-bottom:12px;font-weight:700;">挑戰完成！</div>
    <div style="display:flex;flex-direction:column;gap:8px;">
      <a href="#" target="_blank" id="ctaLine" class="btn">領取檢核清單</a>
      <a href="#" target="_blank" id="ctaSite" class="btn">看 3 分鐘教學</a>
    </div>
    <div style="margin-top:10px"><button class="btn" id="ctaClose">再試一次</button></div>
  </div>
</div>

<script>
// ===== 財經事件數據 =====
const EVENTS = {
  "2025-01-03": { time: "21:30", text: "🇺🇸 美國非農就業數據 (NFP)", impact: 3 },
  "2025-01-15": { time: "21:30", text: "🇺� 美國消費者物價指數 (CPI)", impact: 3 },
  "2025-01-29": { time: "03:00", text: "🇺🇸 聯準會利率決議 (FOMC)", impact: 3 },
  "2025-02-07": { time: "21:30", text: "🇺🇸 美國非農就業數據 (NFP)", impact: 3 },
  "2025-02-14": { time: "21:30", text: "🇺🇸 美國零售銷售數據", impact: 2 },
  "2025-03-07": { time: "21:30", text: "🇺🇸 美國非農就業數據 (NFP)", impact: 3 },
  "2025-03-19": { time: "03:00", text: "🇺🇸 聯準會利率決議 (FOMC)", impact: 3 },
  "2025-04-04": { time: "21:30", text: "🇺🇸 美國非農就業數據 (NFP)", impact: 3 },
  "2025-04-18": { time: "00:00", text: "✝️ 耶穌受難日 (多國休市)", impact: 1 },
  "2025-05-01": { time: "03:00", text: "🇺🇸 聯準會利率決議 (FOMC)", impact: 3 },
  "2025-05-02": { time: "21:30", text: "🇺🇸 美國非農就業數據 (NFP)", impact: 3 },
  "2025-05-26": { time: "00:00", text: "🇺🇸 陣亡將士紀念日 (美股休市)", impact: 1 },
  "2025-06-06": { time: "21:30", text: "🇺🇸 美國非農就業數據 (NFP)", impact: 3 },
  "2025-06-19": { time: "03:00", text: "🇺🇸 聯準會利率決議 (FOMC)", impact: 3 },
  "2025-07-04": { time: "00:00", text: "🇺🇸 美國獨立紀念日 (美股休市)", impact: 1 },
  "2025-07-31": { time: "03:00", text: "🇺🇸 聯準會利率決議 (FOMC)", impact: 3 },
  "2025-08-01": { time: "21:30", text: "🇺🇸 美國非農就業數據 (NFP)", impact: 3 },
};

// ===== Config =====
const CONFIG = {
  symbol: "XAUUSD",
  timeframe: "M15",
  playSpeed: 650,
  startBars: 60,
  windowBars: 200,
};

// ===== State =====
const state = {
  timeframe: CONFIG.timeframe,
  playSpeed: CONFIG.playSpeed,
  bars: [],
  visible: 0,
  timer: null,
  dataset: [],
  view:{scaleX:1, offsetBar:0, userPanned:false, followTail:true},
  positions: [],
  orders: [],
  trades: [],
  journal: [],
  tour: {step:0, enabled:false}
};
const el=id=>document.getElementById(id);
const ECON = { initialBalance: 1000, pipValuePerLot: 1 };
const account = { balance: ECON.initialBalance, equity: ECON.initialBalance };

const PATH = {
  nodes: [
    { id:'lots',    title:'輸入手數',           desc:'在下單區輸入手數',         reward:100, done:false, dep:[] },
    { id:'setSL',   title:'設定停損價',         desc:'任一持倉有 SL',           reward:100, done:false, dep:['lots'] },
    { id:'mktOpen', title:'完成一筆市價下單',   desc:'買入或賣出任一筆',         reward:100, done:false, dep:['lots'] },
    { id:'pend',    title:'完成一筆掛單觸發',   desc:'掛單(Limit/Stop)被成交',   reward:100, done:false, dep:['mktOpen'] },
    { id:'profit',  title:'完成一次獲利平倉',   desc:'任何單獲利 > 0',           reward:100, done:false, dep:['mktOpen'] },
  ]
};
function loadPath(){
  try{
    const raw=localStorage.getItem('TRADER_PATH'); if(raw){ const s=JSON.parse(raw);
      PATH.nodes.forEach(n=>{ const o=s[n.id]; if(o){ n.done=o.done; if(o.done) account.balance += n.reward; }});
      account.equity = account.balance;
    }
  }catch(_){ }
}
function savePath(){
  const s={}; PATH.nodes.forEach(n=> s[n.id]={done:n.done}); localStorage.setItem('TRADER_PATH',JSON.stringify(s));
}
function renderPath(){
  const g=document.getElementById('pathGrid'); if(!g) return;
  g.innerHTML = PATH.nodes.map(n=>{
    const lock = n.dep.some(d=> !PATH.nodes.find(x=>x.id===d)?.done );
    const st   = n.done ? '完成' : (lock?'鎖定':'可挑戰');
    return `<div style="border:1px solid var(--border-color);border-radius:12px;padding:10px;background:${n.done?'rgba(40,199,130,0.1)':(lock?'rgba(75,81,105,0.2)':'var(--panel-soft)')}">
      <div style="font-weight:700">${n.title}</div>
      <div style="font-size:12px;color:var(--muted);min-height:36px">${n.desc}</div>
      <div style="font-size:12px">獎勵：$${n.reward}｜狀態：${st}</div>
    </div>`;
  }).join('');
}
function completeNode(id){
  const n = PATH.nodes.find(x=>x.id===id); if(!n || n.done) return;
  n.done=true; account.balance += n.reward; account.equity = account.balance;
  savePath(); renderPath(); refreshHUD();
  makeConfetti(40); sfx(1200,160); toast(`任務完成：「${n.title}」＋$${n.reward}`);
}
function loadPathAndRender(){ loadPath(); renderPath(); }
function toast(msg,ms=1200){const t=document.createElement('div');t.className='toast';t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),ms);}

function sfx(freq=880, dur=120, vol=.12){
  try{
    const a=new AudioContext(), o=a.createOscillator(), g=a.createGain();
    o.frequency.value=freq; o.connect(g); g.gain.value=vol; g.connect(a.destination);
    o.start(); g.gain.exponentialRampToValueAtTime(0.0001, a.currentTime+dur/1000); o.stop(a.currentTime+dur/1000);
  }catch(_){ }
}

function makeConfetti(n=40){
  const box=document.getElementById('confetti'); box.innerHTML='';
  for(let i=0;i<n;i++){
    const d=document.createElement('div');
    d.style.cssText=`position:absolute;left:${Math.random()*100}%;top:-10px;width:6px;height:10px;background:hsl(${Math.random()*360},90%,60%);opacity:.9;transform:rotate(${Math.random()*360}deg);`;
    box.appendChild(d);
    const t=Math.random()*1.2+0.8;
    d.animate([{transform:'translateY(0)'},{transform:`translateY(${window.innerHeight+40}px)`}],{duration:t*1000,easing:'cubic-bezier(.2,.8,.2,1)'}).onfinish=()=>d.remove();
  }
  setTimeout(()=>box.innerHTML='',1500);
}

state.journal = state.journal || [];
function logEvent(kind, payload){
  state.journal.push({t: state.bars[state.visible-1]?.fullDate || '', kind, ...payload});
  renderJournal();
}
function renderJournal(){
  const box=document.getElementById('journalBody'); if(!box) return;
  box.innerHTML = state.journal.slice(-50).reverse().map(j=>{
    const side = j.side ? (j.side==='LONG'?'多':'空') : '';
    return `<tr><td>${j.t}</td><td>${j.kind}</td><td>${side}</td><td>${j.price?.toFixed?j.price.toFixed(2):''}</td><td>${j.size||''}</td><td>${j.note||''}</td></tr>`;
  }).join('');
}

function guideStart(){ state.tour={step:0, enabled:true}; guideNext(); }
function guideNext(){
  const steps = [
    {el:'#lots', tip:'① 先輸入手數（每跳1點 = 每手 $1）', enable:['#lots']},
    {el:'#btnBuyNow', tip:'② 點「立即買入」或「立即賣出」建倉', enable:['#btnBuyNow','#btnSellNow']},
    {el:'.orderDock', tip:'③ 看這裡：即時顯示停損金額、持倉損益'},
    {el:'#posBody', tip:'④ 點持倉列右側「×」手動平倉完成一局', enable:['#posBody button']}
  ];
  const m=el('tourMask'), t=el('tourTip');
  if(!state.tour.enabled){ m.style.display=t.style.display='none'; document.querySelectorAll('.tour-disabled').forEach(e=>e.disabled=false); document.querySelectorAll('.tour-hi').forEach(e=>e.classList.remove('tour-hi')); return; }
  const s = steps[state.tour.step];
  if(!s){ m.style.display=t.style.display='none'; state.tour.enabled=false; document.querySelectorAll('.tour-disabled').forEach(e=>e.disabled=false); document.querySelectorAll('.tour-hi').forEach(e=>e.classList.remove('tour-hi')); return; }
  document.querySelectorAll('button,input').forEach(e=>{ e.disabled=true; e.classList.add('tour-disabled'); });
  if(s.enable){ s.enable.forEach(sel=>{ document.querySelectorAll(sel).forEach(e=>e.disabled=false); }); }
  document.querySelectorAll('.tour-hi').forEach(e=>e.classList.remove('tour-hi'));
  const target=document.querySelector(s.el); target?.classList.add('tour-hi');
  const r = target.getBoundingClientRect();
  m.style.display=t.style.display='block';
  t.style.left=`${r.left}px`; t.style.top=`${r.bottom+8}px`;
  t.innerHTML = `<div>${s.tip}</div><button class="next btn">下一步</button>`;
  t.querySelector('.next').onclick=()=>{ state.tour.step++; guideNext(); };
}
el('btnGuide').onclick=guideStart;

function showCTA(p){
  el('ctaInfo').textContent = `本局結果：${p.realizedUsd>=0?'+':'-'}$${Math.abs(p.realizedUsd).toFixed(2)} / ${p.realizedR>=0?'+':'-'}${Math.abs(p.realizedR).toFixed(2)}R`;
  el('ctaPanel').style.display='block';
}
el('ctaClose').onclick=()=>{ el('ctaPanel').style.display='none'; reset(); };

// ===== CSV loader =====
function qs(name){ return new URLSearchParams(location.search).get(name); }
function guessGitHubRaw(){
  if(location.hostname.endsWith('github.io')){
    const owner = location.hostname.split('.')[0];
    const repo = location.pathname.split('/').filter(Boolean)[0] || '';
    if(repo){
      return [
        `${location.protocol}//${location.host}/${repo}/XAUUSD_M15.csv`,
        `https://raw.githubusercontent.com/${owner}/${repo}/main/XAUUSD_M15.csv`,
        `https://raw.githubusercontent.com/${owner}/${repo}/master/XAUUSD_M15.csv`
      ];
    }
  }
  return [];
}
function candidateCSVUrls(){
  const q = qs('csv');
  const list = [];
  if(q) list.push(q);
  list.push('XAUUSD_M15.csv','./XAUUSD_M15.csv','/XAUUSD_M15.csv');
  list.push(...guessGitHubRaw());
  return list;
}
async function loadFirstCSV(){
  const urls = candidateCSVUrls();
  for(const u of urls){
    try{
      const r = await fetch(u, {cache:'no-store', mode:'cors'});
      if(r.ok){
        const text = await r.text();
        const rows = parseOHLC(text);
        if(rows.length >= 100){
          console.log('CSV loaded:', u, rows.length);
          return rows;
        }
      }
    }catch(e){ console.warn('fetch failed', u, e); }
  }
  return [];
}
function parseOHLC(text){
  if(!text) return [];
  if(text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
  const lines = text.split(/\r?\n/).filter(l => l && !/^#/.test(l));
  if(lines.length < 2) return [];
  const first = lines.find(l => /[0-9]/.test(l)) || lines[0];
  let delim = ',';
  if(first.includes(';')) delim = ';';
  else if(first.includes('\t')) delim = '\t';
  const hdrLower = lines[0].toLowerCase();
  const hasHeader = /(time|date)/.test(hdrLower) && /(open|high|low|close)/.test(hdrLower);
  const cols = hasHeader ? hdrLower.split(delim) : null;
  const idx = (k)=> hasHeader ? cols.findIndex(x=>x.includes(k)) : -1;
  const out = [];
  for(let n = hasHeader?1:0; n < lines.length; n++){
    const a = lines[n].split(delim).map(s => s.trim());
    if(a.length < 5) continue;
    let dt, o, h, l, c;
    if(/^\d{4}[-./]\d{2}[-./]\d{2}\s+\d{1,2}:\d{2}(:\d{2})?$/.test(a[0])){
      dt = a[0].replace(/[.]/g,'-');
      o = parseFloat(a[1]); h = parseFloat(a[2]); l = parseFloat(a[3]); c = parseFloat(a[4]);
    }
    else if(/^\d{4}[-./]\d{2}[-./]\d{2}$/.test(a[0]) && /^\d{1,2}:\d{2}(:\d{2})?$/.test(a[1])){
      dt = a[0].replace(/[.]/g,'-') + ' ' + a[1];
      o = parseFloat(a[2]); h = parseFloat(a[3]); l = parseFloat(a[4]); c = parseFloat(a[5]);
    }
    else if(hasHeader){
      const ti = idx('time')>-1 ? idx('time') : idx('date');
      dt = (a[ti] || '').replace(/[.]/g,'-');
      o = parseFloat(a[idx('open')]); h = parseFloat(a[idx('high')]);
      l = parseFloat(a[idx('low')]);  c = parseFloat(a[idx('close')]);
    }else{ continue; }
    if(!isFinite(o)||!isFinite(h)||!isFinite(l)||!isFinite(c)) continue;
    out.push({ t: new Date(dt), o, h, l, c });
  }
  out.sort((x,y)=>x.t - y.t);
  return out;
}

function prepareFromDataset(rows){
  const bars = rows.map((b,i)=>{
    const date = b.t.toISOString().slice(0, 10);
    return {
      t: `${String(b.t.getHours()).padStart(2,'0')}:${String(b.t.getMinutes()).padStart(2,'0')}`,
      fullDate: date,
      o: i ? rows[i-1].c : b.o,
      h: b.h, l: b.l, c: b.c,
      event: EVENTS[date]
    };
  });
  state.bars = bars;
  const minTail = 200, startMin = 60;
  const maxIdx = Math.max(startMin, bars.length - minTail);
  const anchorIdx = Math.floor(Math.random() * maxIdx);
  state.visible = Math.max(startMin, anchorIdx);
  state.view = { scaleX:1, offsetBar:0, userPanned:false, followTail:true };
  state.positions=[]; state.orders=[]; state.trades=[];
}
function currentWindow(){
  const total = state.bars.length;
  const right = Math.max(1, Math.min(state.visible, total));
  const win   = CONFIG.windowBars || 200;
  let start, end;
  if (state.view.followTail) {
    start = Math.max(0, right - win);
    end   = right;
  } else {
    const off = state.view.offsetBar || 0;
    start = Math.max(0, Math.min(total - win, right - win + off));
    end   = Math.min(total, start + win);
  }
  return { start, end, win, right, total };
}

// ===== Rendering =====
const canvas=el('chart'); const pxAxis=el('priceAxis'); const tmAxis=el('timeAxis');
const tooltip = el('tooltip');
let pan=false, lastX=0, panAccum=0;
function draw(){
  const ctx = canvas.getContext('2d'); const W = canvas.width = canvas.clientWidth; const H = canvas.height = canvas.clientHeight;
  ctx.clearRect(0,0,W,H);
  const {start,end} = currentWindow();
  const data=state.bars.slice(start,end);
  if(!data.length) return;
  const hi = Math.max(...data.map(b=>b.h));
  const lo = Math.min(...data.map(b=>b.l));
  const pad = (hi - lo) * 0.12 || 5;
  const yMax = hi + pad, yMin = lo - pad;
  const xStep = W / Math.max(48, data.length + 2);
  const y = v => H - (v - yMin) / (yMax - yMin) * H;
  
  const style = getComputedStyle(document.documentElement);
  const gridColor = style.getPropertyValue('--grid').trim();
  const upStroke = style.getPropertyValue('--k-up-stroke').trim();
  const upFill   = style.getPropertyValue('--k-up-fill').trim();
  const dnStroke = style.getPropertyValue('--k-down-stroke').trim();
  const dnFill   = style.getPropertyValue('--k-down-fill').trim();

  ctx.strokeStyle = gridColor;
  for (let i = 0; i < 6; i++) { const yv = H * i / 5; ctx.beginPath(); ctx.moveTo(0, yv); ctx.lineTo(W, yv); ctx.stroke(); }
  ctx.setLineDash([2,4]);
  for (let i = 0; i < data.length; i += 4) { const x = 24 + i * xStep; ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
  ctx.setLineDash([]);

  for(let i=0;i<data.length;i++){
    const b = data[i], x = 24 + i * xStep, up = b.c >= b.o;
    ctx.strokeStyle = up ? upStroke : dnStroke;
    ctx.fillStyle   = up ? upFill   : dnFill;
    ctx.beginPath(); ctx.moveTo(x,y(b.h)); ctx.lineTo(x,y(b.l)); ctx.stroke();
    const w = Math.max(3, xStep * 0.6), y1 = y(b.o), y2 = y(b.c);
    ctx.fillRect(x - w/2, Math.min(y1, y2), w, Math.max(2, Math.abs(y1 - y2)));
  }
  
  state.positions.forEach((p,idx)=>{
    const color = p.side === 'LONG' ? 'var(--good)' : 'var(--danger)';
    ctx.strokeStyle = color; ctx.setLineDash([5,4]);
    ctx.beginPath(); ctx.moveTo(0, y(p.entry)); ctx.lineTo(W, y(p.entry)); ctx.stroke();
    ctx.setLineDash([]); ctx.fillStyle = color; ctx.font = '12px system-ui';
    const rTxt = Number.isFinite(p.pnlR) ? p.pnlR.toFixed(2) : '0.00';
    const uTxt = Number.isFinite(p.pnlUsd) ? p.pnlUsd.toFixed(2) : '0.00';
    ctx.fillText(`${p.side} @ ${p.entry.toFixed(2)} | ${rTxt}R / $${uTxt}`, 20, 28 + 14 * idx);
  });

  pxAxis.innerHTML=''; for(let i=0;i<=6;i++){ const v=yMin+(yMax-yMin)*i/6; const d=document.createElement('div'); d.className='tick'; d.style.top=`${H-(H*i/6)}px`; d.textContent=v.toFixed(2); pxAxis.appendChild(d); }
  tmAxis.innerHTML=''; 
  let lastDate = null;
  for(let i=0;i<data.length;i+=4){ 
    const bar = data[i];
    const d=document.createElement('div'); d.className='tick'; d.style.left=`${(24+i*xStep)}px`; 
    if (bar.fullDate !== lastDate) {
        d.textContent = bar.fullDate.slice(5); // 顯示 月-日
        lastDate = bar.fullDate;
    } else {
        d.textContent = bar.t;
    }
    tmAxis.appendChild(d); 
    
    if (bar.event && bar.t === bar.event.time) {
        const eventMarker = document.createElement('div');
        eventMarker.className = 'event-marker';
        eventMarker.style.left = `${(24+i*xStep)}px`;
        eventMarker.textContent = '🔥'; // 事件圖示
        eventMarker.dataset.tooltip = `[${bar.fullDate} ${bar.event.time}] ${bar.event.text}`;
        tmAxis.appendChild(eventMarker);
    }
  } 
}

canvas.addEventListener('mousedown', e => { pan = true; lastX = e.clientX; state.view.userPanned = true; state.view.followTail = false; });
window.addEventListener('mouseup', () => { pan = false; });
canvas.addEventListener('mousemove', e => {
  if (!pan) return;
  const dx = e.clientX - lastX; lastX = e.clientX; panAccum += dx;
  if(Math.abs(panAccum) >= 8){
    const { right, total } = currentWindow();
    const step  = panAccum>0 ? -1 : 1;
    state.view.offsetBar = Math.max(-(right - 1), Math.min((total - right) - 1, (state.view.offsetBar||0) + step));
    panAccum %= 8;
    draw();
  }
});
tmAxis.addEventListener('mouseover', e => {
    if (e.target.classList.contains('event-marker')) {
        tooltip.style.display = 'block';
        tooltip.textContent = e.target.dataset.tooltip;
    }
});
tmAxis.addEventListener('mousemove', e => {
    if (tooltip.style.display === 'block') {
        tooltip.style.left = `${e.clientX + 15}px`;
        tooltip.style.top = `${e.clientY - 30}px`;
    }
});
tmAxis.addEventListener('mouseout', e => {
    if (e.target.classList.contains('event-marker')) {
        tooltip.style.display = 'none';
    }
});


// ===== HUD & Banners =====
function refreshHUD(){
  const last = state.bars[state.visible-1];
  if(last){
    el('qBid').textContent = last.c.toFixed(2);
    el('qAsk').textContent = (last.c+0.2).toFixed(2);
  }
  el('hudInfo').textContent = `XAUUSD M15｜本金 $${account.balance.toFixed(2)}｜已實現 $${(account.balance-ECON.initialBalance).toFixed(2)}`;
}

function num(v){ const x=parseFloat(v); return Number.isFinite(x)?x:NaN; }
function getInputs(){
  return {
    lots: num(el('lots').value), sl: num(el('slPrice').value),
    tp: num(el('tpPrice').value), pend: num(el('pendPrice').value)
  };
}
function lastQuote(){
  const mid = state.bars[state.visible-1]?.c ?? 0;
  return { mid, bid: mid - 0.1, ask: mid + 0.1 };
}
function computeRiskPreview(){
  const p=getInputs(), q=lastQuote();
  const lots=p.lots||0, sl=p.sl;
  let rBuy=0, rSell=0, rPend=0;
  if(lots>0 && sl!=null){
    rBuy  = Math.abs(q.ask - sl) * lots;
    rSell = Math.abs(q.bid - sl) * lots;
  }
  if(lots>0 && p.pend && sl!=null){
    rPend = Math.abs(p.pend - sl) * lots;
  }
  el('riskBuy').textContent  = `買入停損：$${rBuy.toFixed(2)}`;
  el('riskSell').textContent = `賣出停損：$${rSell.toFixed(2)}`;
  el('riskPend').textContent = `掛單停損：$${rPend.toFixed(2)}`;
}

function renderPositions(){
  const box=el('posBody'); if(!box) return;
  box.innerHTML = state.positions.map((p,i)=>{
    const pnl = p.pnlUsd || 0;
    const pnlClass = pnl > 0 ? 'pnl-up' : (pnl < 0 ? 'pnl-down' : 'pnl-neutral');
    return `<tr><td>${p.side==='LONG'?'多':'空'}</td><td>${p.entry.toFixed(2)}</td><td>${p.sl?.toFixed(2)||''}</td><td>${p.tp?.toFixed(2)||''}</td><td>${p.size}</td><td class="${pnlClass}">${pnl.toFixed(2)}</td><td><button data-i="${i}" class="btn">×</button></td></tr>`;
  }).join('');
  box.querySelectorAll('button').forEach(btn=>{
    btn.onclick=()=>{ closePosition(parseInt(btn.dataset.i,10)); };
  });
}

function recalcAccount(){
  account.equity = account.balance + state.positions.reduce((sum, p) => sum + (p.pnlUsd || 0), 0);
}

function validBrackets(side, entry, sl, tp){
  const okSL = (sl==null) || (side==='LONG' ? sl < entry : sl > entry);
  const okTP = (tp==null) || (side==='LONG' ? tp > entry : tp < entry);
  return {ok: okSL && okTP, okSL, okTP};
}

function openMarket(side){
  const p=getInputs();
  if(!(p.lots>0)) return toast('請先輸入「手數」');
  const q=lastQuote(), entry = side==='LONG' ? q.ask : q.bid;
  const chk = validBrackets(side, entry, p.sl, p.tp);
  if(!chk.ok){ toast(!chk.okSL ? '停損價不合理' : '停利價不合理'); return; }
  state.positions.push({ id: Date.now(), side, entry, sl:p.sl, tp:p.tp, size: p.lots, R0: p.sl!=null ? Math.abs(entry-p.sl) : 1 });
  logEvent('開倉',{side,price:entry,size:p.lots});
  if(p.lots>0) completeNode('lots'); if(p.sl) completeNode('setSL'); completeNode('mktOpen');
  recalcAccount(); renderPositions(); refreshHUD(); draw(); computeRiskPreview();
  toast(`${side==='LONG'?'買入':'賣出'} @ ${entry.toFixed(2)} 開倉`);
  if(state.tour.enabled && state.tour.step===1){ state.tour.step++; guideNext(); }
}

function placePending(side){
  const p=getInputs();
  if(!(p.lots>0) || !p.pend) return toast('掛單請輸入「手數」「掛單價」');
  const q=lastQuote();
  const type = (side==='LONG') ? (p.pend<q.bid ? 'LIMIT':'STOP') : (p.pend>q.ask ? 'LIMIT':'STOP');
  const chk = validBrackets(side, p.pend, p.sl, p.tp);
  if(!chk.ok){ toast(!chk.okSL ? '停損價不合理' : '停利價不合理'); return; }
  state.orders=state.orders||[];
  state.orders.push({ id: Date.now(), side, type, price:p.pend, sl:p.sl, tp:p.tp, size:p.lots });
  if(p.lots>0) completeNode('lots'); if(p.sl) completeNode('setSL');
  toast(`${side==='LONG'?'掛單買入':'賣出'} ${type} @ ${p.pend.toFixed(2)} 已建立`);
}

function closePosition(idx, exit, reason='手動'){
  const p = state.positions[idx]; if(!p) return;
  const fill = exit ?? (p.side==='LONG'?lastQuote().bid:lastQuote().ask);
  const sign = p.side==='LONG'?1:-1;
  const pnlUsd = (fill - p.entry) * sign * p.size;
  p.realizedUsd = pnlUsd; p.realizedR = (fill - p.entry) * sign / (p.R0||1);
  account.balance += pnlUsd;
  state.positions.splice(idx,1);
  logEvent('平倉',{side:p.side,price:fill,size:p.size,note:reason});
  if(pnlUsd > 0) completeNode('profit');
  if(p.realizedUsd >= 0){
    el('orderDock').classList.add('profitPulse');
    setTimeout(()=>el('orderDock').classList.remove('profitPulse'), 900);
    makeConfetti(50); sfx(1200,150);
    toast(`獲利平倉 +$${p.realizedUsd.toFixed(2)}`);
  } else {
    el('chartWrap').classList.add('lossShake');
    setTimeout(()=>el('chartWrap').classList.remove('lossShake'), 600);
    sfx(200,200,.18);
    toast(`虧損平倉 -$${Math.abs(p.realizedUsd).toFixed(2)}`);
  }
  recalcAccount(); renderPositions(); refreshHUD();
  if(state.tour.enabled && state.tour.step===3){ state.tour.step++; guideNext(); }
  if(state.positions.length===0) showCTA(p);
}

function closeAll(){ state.positions.slice().reverse().forEach((p,i)=>closePosition(state.positions.length - 1 - i, undefined, '平倉全部')); computeRiskPreview(); }

function updateOrders(){
  if(!state.orders?.length) return;
  const q=lastQuote();
  state.orders = state.orders.filter(o => {
    const hit = (o.side==='LONG') ? (o.type==='LIMIT' ? q.ask<=o.price : q.ask>=o.price) : (o.type==='LIMIT' ? q.bid>=o.price : q.bid<=o.price);
    if(hit){
      const entry=(o.side==='LONG')?q.ask:q.bid;
      state.positions.push({ id:Date.now(), side:o.side, entry, sl:o.sl, tp:o.tp, size:o.size, R0:o.sl!=null?Math.abs(entry-o.sl):1 });
      logEvent('掛單觸發',{side:o.side,price:entry,size:o.size});
      completeNode('pend');
      return false;
    }
    return true;
  });
}

function updatePositions(){
  const q=lastQuote();
  let changed = false;
  for(let i=state.positions.length-1;i>=0;i--){
    const p=state.positions[i];
    const exitPx = p.side==='LONG'?q.bid:q.ask;
    p.pnlUsd = (exitPx - p.entry) * (p.side==='LONG'?1:-1) * p.size;
    p.pnlR = (q.mid - p.entry) * (p.side==='LONG'?1:-1) / (p.R0 || 1);
    const hitSL = p.sl && ((p.side==='LONG' && q.bid<=p.sl) || (p.side!=='LONG' && q.ask>=p.sl));
    const hitTP = p.tp && ((p.side==='LONG' && q.bid>=p.tp) || (p.side!=='LONG' && q.ask<=p.tp));
    if(hitSL || hitTP){
      closePosition(i, hitSL? p.sl : p.tp, hitSL?'SL':'TP');
      changed = true;
    }
  }
  recalcAccount();
  renderPositions();
  refreshHUD();
}

// ===== Playback =====
function togglePlay(force){ const playing=!!state.timer; if(playing && !force){ clearInterval(state.timer); state.timer=null; toast('暫停'); return;} if(!playing){ state.timer=setInterval(stepOnce,state.playSpeed); toast('播放中…'); }}
function stepOnce(){
  if(state.visible >= state.bars.length){ clearInterval(state.timer); state.timer=null; return; }
  state.visible++;
  if (state.view.followTail) { state.view.userPanned = false; state.view.offsetBar = 0; }
  draw();
  updateOrders();
  updatePositions();
  computeRiskPreview();
  refreshHUD();
}

// ===== Boot / Reset =====
async function boot(){ state.dataset = await loadFirstCSV(); if(state.dataset.length===0){ console.error('無法載入CSV'); } reset(); }
function reset(){ clearInterval(state.timer); state.timer=null; state.visible=0; state.positions=[]; state.orders=[]; state.trades=[]; state.journal=[];
  state.view.offsetBar = 0; state.view.userPanned = false; state.view.followTail = true;
  if(state.dataset.length){
    prepareFromDataset(state.dataset);
    draw(); refreshHUD(); computeRiskPreview(); renderPositions(); renderJournal();
  } else {
    state.bars=[]; draw(); refreshHUD(); renderPositions(); renderJournal(); toast('請提供 M15 CSV');
  }
}

// --- Event Listeners ---
el('spdSeg').addEventListener('click',e=>{ if(e.target.tagName!=='BUTTON')return; [...e.currentTarget.children].forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); state.playSpeed=parseInt(e.target.dataset.spd,10); });
el('btnPlay').onclick=()=>togglePlay();
el('btnStep').onclick=()=>stepOnce();
el('btnLive').onclick=()=>{ state.view.offsetBar=0; state.view.userPanned=false; state.view.followTail=true; draw(); };
window.addEventListener('keydown',e=>{ if(e.code==='Space')togglePlay(); if(e.code==='ArrowRight')stepOnce(); if(e.key.toLowerCase()==='f')el('btnLive').click(); });
el('btnBuyNow').onclick=()=>openMarket('LONG');
el('btnSellNow').onclick=()=>openMarket('SHORT');
el('btnPendBuy').onclick=()=>placePending('LONG');
el('btnPendSell').onclick=()=>placePending('SHORT');
el('btnCloseAll').onclick=()=>closeAll();
el('btnReroll').onclick=()=>{ reset(); toast('已隨機選擇新的起始位置'); };
el('barsRange').oninput=e=>{ CONFIG.windowBars=parseInt(e.target.value,10)||200; draw(); };
el('hRange').oninput=e=>{ const h=parseInt(e.target.value,10)||560; el('chart').style.height=h+'px'; el('chartWrap').style.minHeight=h+'px'; draw(); };
['lots','slPrice','tpPrice','pendPrice'].forEach(id=> el(id).addEventListener('input', computeRiskPreview));
el('btnPath').onclick = ()=>{ el('pathPanel').style.display='block'; renderPath(); };
el('btnPathClose').onclick = ()=>{ el('pathPanel').style.display='none'; };

// --- Init ---
loadPathAndRender();
boot();

</script>
</body>
</html>
�
